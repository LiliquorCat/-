<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海拉的钱包</title>
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.js"></script>
    <style>
        /* 基础样式 - 修改颜色方案 */
        .gacha-calculator {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a1a1a; /* 深黑色背景 */
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .pie-canvas {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            -ms-interpolation-mode: nearest-neighbor;
        }

        /* 添加栅栏效果背景 */
        .gacha-calculator::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(90deg, rgba(139, 0, 0, 0.1) 1px, transparent 1px),
                linear-gradient(0deg, rgba(139, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 0;
        }

        .calculator-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
            position: relative;
            z-index: 1;
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: #2a2a2a; /* 深灰色背景 */
            padding: 20px;
            border-radius: 8px; /* 减少圆角，更硬朗 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), 
                        inset 0 0 0 1px rgba(255, 107, 107, 0.2); /* 厚重阴影和红色内边框 */
            border: 2px solid #333333; /* 厚重边框 */
            position: relative;
        }

        /* 添加锁链装饰元素 */
        .card::after {
            content: "⛓️";
            position: absolute;
            top: -10px;
            right: 10px;
            font-size: 16px;
            color: #8B0000; /* 深红色 */
            opacity: 0.7;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            color: #FF6B6B; /* 亮红色文字 */
            margin-bottom: 15px;
            font-size: 18px;
            user-select: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .section-header:hover {
            color: #FF4500; /* 橙红色悬停 */
        }

        .collapse-icon {
            font-weight: bold;
            font-size: 16px;
            color: #FF6B6B; /* 亮红色 */
        }

        .section-content {
            margin-top: 10px;
        }

        h1 {
            text-align: center;
            color: #FF6B6B; /* 亮红色 */
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border-bottom: 2px solid #8B0000; /* 深红色下划线 */
            padding-bottom: 10px;
        }

        h2 {
            color: #FF6B6B; /* 亮红色 */
            margin-bottom: 15px;
            font-size: 18px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .sub-section {
            margin: 20px 0;
            padding: 15px;
            background: #333333; /* 深灰色背景 */
            border-radius: 6px;
            border-left: 4px solid #FF4500; /* 橙红色边框 */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }

        .sub-title {
            color: #FF6B6B; /* 亮红色 */
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        /* 更强大的固定定位方案 */
        .sticky-panel {
            position: sticky;
            top: 20px;
            align-self: flex-start;
            z-index: 1000; /* 更高的z-index */
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            /* 确保有足够的空间 */
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        /* 防止父元素overflow隐藏 */
        .calculator-layout {
            overflow: visible !important;
        }

        .gacha-calculator {
            overflow: visible !important;
        }

        /* 当前库存垂直布局 */
        .resource-vertical {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .resource-input-vertical {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #333333; /* 深灰色背景 */
            border-radius: 6px;
            border: 1px solid #444444; /* 深色边框 */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .resource-input-vertical label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            min-width: 120px;
            margin-bottom: 0;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .resource-input-vertical input {
            padding: 8px;
            border: 1px solid #555555;
            border-radius: 5px;
            width: 100px;
            text-align: center;
            background: #2a2a2a;
            color: #FFFFFF;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        /* 皮肤预留一行显示 - 修改按键布局 */
        .skin-reserve-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .skin-item.compact {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: #333333; /* 深灰色背景 */
            border-radius: 6px;
            border: 1px solid #444444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .skin-item.compact .skin-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .skin-item.compact .skin-price {
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .skin-item.compact .skin-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .skin-item.compact .skin-count {
            color: #FF4500; /* 橙红色 */
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .skin-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #555555;
            background: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FF6B6B;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .skin-btn:hover {
            background: #3a3a3a;
            border-color: #FF4500;
        }

        .skin-btn:active {
            background: #1a1a1a;
            transform: translateY(1px);
        }

        /* 角色养成按钮样式 */
        .character-development-controls input {
            padding: 8px;
            border: 1px solid #555555;
            border-radius: 5px;
            width: 70px;
            text-align: center;
            font-size: 14px;
            min-width: 0;
            background: #2a2a2a;
            color: #FFFFFF;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .character-dev-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #555555;
            background: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FF6B6B;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .character-dev-btn:hover {
            background: #3a3a3a;
            border-color: #FF4500;
        }

        .character-dev-btn:active {
            background: #1a1a1a;
            transform: translateY(1px);
        }

        .character-dev-count {
            color: #FF4500; /* 橙红色 */
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        /* 暗域开关组样式 */
        .dark-zone-switches {
            display: flex;
            gap: 15px;
        }

        /* 数据间隙样式 */
        .data-gap-subsection {
            margin: 15px 0;
            padding: 12px;
            background: #333333; /* 深灰色背景 */
            border-radius: 6px;
            border: 1px solid #444444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .data-gap-title {
            font-size: 14px;
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            margin-bottom: 10px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .target-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .target-btn, .rating-btn {
            padding: 10px 8px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .target-btn:hover, .rating-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .target-btn.active, .rating-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        /* 新增模块按钮样式 */
        .main-story-buttons {
            margin-top: 10px;
        }

        .main-story-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .main-story-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .main-story-btn {
            padding: 10px 8px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .main-story-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .main-story-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        /* 狄斯暗影（EX）按钮样式 */
        .ex-buttons {
            margin-top: 10px;
        }

        .ex-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .ex-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ex-btn {
            padding: 10px 8px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .ex-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .ex-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        .memory-storm-buttons,
        .pollution-nest-buttons,
        .cleanup-operation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .memory-storm-btn,
        .pollution-nest-btn,
        .cleanup-operation-btn {
            padding: 10px 8px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .memory-storm-btn:hover,
        .pollution-nest-btn:hover,
        .cleanup-operation-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .memory-storm-btn.active,
        .pollution-nest-btn.active,
        .cleanup-operation-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        .palma-ruins-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .palma-ruins-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .palma-ruins-btn {
            padding: 10px 8px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .palma-ruins-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .palma-ruins-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        /* 资源图标样式 */
        .resource-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin: 0 2px;
        }

        .resource-icon.small {
            width: 16px;
            height: 16px;
        }

        /* 其他原有样式 */
        .resource-input {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .resource-input label {
            width: 120px;
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .resource-input input {
            padding: 8px;
            border: 1px solid #555555;
            border-radius: 5px;
            width: 120px;
            background: #2a2a2a;
            color: #FFFFFF;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .custom-adjust {
            margin-top: 10px;
        }

        .custom-tip {
            font-size: 12px;
            color: #FF4500; /* 橙红色 */
            margin-top: 5px;
            font-style: italic;
        }

        .accumulation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: #333333; /* 深灰色背景 */
            border-radius: 5px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .item-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .item-title {
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            min-width: 120px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .item-subtitle {
            color: #CCCCCC;
            min-width: 80px;
            font-size: 14px;
        }

        .item-value {
            font-weight: bold;
            color: #FF4500; /* 橙红色 */
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 2px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .switch-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }

        .switch-group.small {
            margin: 0 0 0 10px;
        }

        .switch {
            position: relative;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555555;
            transition: .4s;
            border-radius: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #8B0000; /* 深红色 */
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .switch-label {
            font-size: 12px;
            margin-left: 5px;
            color: #CCCCCC;
        }

        /* 在这里添加开关标签高亮样式 */
        .switch-label.active {
            color: #FF4500; /* 橙红色 */
            font-weight: bold;
        }

        .switch-label.inactive {
            color: #666666;
        }

        .time-options {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .time-option {
            flex: 1;
            padding: 12px;
            min-width: 0;
            background: #333333; /* 深灰色背景 */
            border: 2px solid #444444;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .time-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            gap: 5px;
        }

        .time-title {
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
            color: #FF6B6B; /* 亮红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .time-days {
            font-size: 14px;
            font-weight: bold;
            color: #FF4500; /* 橙红色 */
            flex-shrink: 0;
            white-space: nowrap;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .time-date {
            font-size: 12px;
            color: #CCCCCC;
            text-align: center;
        }

        .time-option.active {
            border-color: #FF4500;
            background: #3a3a3a;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
        }

        .result {
            background: #333333; /* 深灰色背景 */
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 16px;
            color: #CCCCCC;
        }

        .result-item.simple {
            font-size: 18px;
        }

        .result-item.highlight {
            font-weight: bold;
            font-size: 20px;
            border-top: 1px solid #444444;
            padding-top: 10px;
            margin-top: 15px;
            color: #FF4500; /* 橙红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .summary-section {
            margin: 15px 0;
            padding: 15px;
            background: #333333; /* 深灰色背景 */
            border-radius: 8px;
            border-left: 4px solid #FF4500; /* 橙红色边框 */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 16px;
            color: #CCCCCC;
        }

        .summary-label {
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .summary-value {
            font-weight: bold;
            color: #FF4500; /* 橙红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .shop-section {
            margin-top: 15px;
            padding: 15px;
            background: #2a2a2a; /* 深灰色背景 */
            border-radius: 8px;
            border: 1px solid #444444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .shop-title {
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            margin-bottom: 10px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .certification-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .certification-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #555555;
            background: #333333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FF6B6B;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .certification-btn:hover {
            background: #3a3a3a;
            border-color: #FF4500;
        }

        .certification-count {
            font-weight: bold;
            color: #FF4500; /* 橙红色 */
            min-width: 80px;
            text-align: center;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
            background: #333333;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555555;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .training-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .training-btn {
            padding: 12px 8px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .training-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .training-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        .nightmare-score {
            margin-bottom: 20px;
            padding: 15px;
            background: #333333; /* 深灰色背景 */
            border-radius: 8px;
            border: 1px solid #444444;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .score-title {
            font-size: 14px;
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            margin-bottom: 10px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #CCCCCC;
        }

        /* 无尽梦魇滑块样式（大范围） */
        .score-slider {
            width: 100%;
            height: 20px;
            border-radius: 3px;
            background: #2a2a2a; /* 深灰色背景 */
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8B0000; /* 深红色 */
            cursor: pointer;
            border: 2px solid #FF4500; /* 橙红色边框 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .score-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8B0000; /* 深红色 */
            cursor: pointer;
            border: 2px solid #FF4500; /* 橙红色边框 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .score-slider::-webkit-slider-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #555555;
            margin: 7px 0;
        }

        .score-slider::-moz-range-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #555555;
            border: none;
        }

        /* 监察密令滑块样式（小范围） */
        .inspection-slider {
            width: 100%;
            height: 20px;
            border-radius: 3px;
            background: #2a2a2a; /* 深灰色背景 */
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        .inspection-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8B0000; /* 深红色 */
            cursor: pointer;
            border: 2px solid #FF4500; /* 橙红色边框 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .inspection-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8B0000; /* 深红色 */
            cursor: pointer;
            border: 2px solid #FF4500; /* 橙红色边框 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .inspection-slider::-webkit-slider-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #555555;
            margin: 7px 0;
        }

        .inspection-slider::-moz-range-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #555555;
            border: none;
        }

        /* 滑块禁用状态样式 */
        .inspection-slider:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .inspection-slider:disabled::-webkit-slider-thumb {
            background: #444444;
            cursor: not-allowed;
        }
        
        .inspection-slider:disabled::-moz-range-thumb {
            background: #444444;
            cursor: not-allowed;
        }

        .slider-value {
            text-align: center;
            font-size: 12px;
            color: #FF4500; /* 橙红色 */
            margin-top: 5px;
            font-weight: bold;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .score-rewards {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reward-label {
            font-size: 13px;
            color: #CCCCCC;
        }

        .reward-value {
            font-size: 13px;
            font-weight: bold;
            color: #FF4500; /* 橙红色 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        /* 禁用状态样式 */
        .disabled-section {
            opacity: 0.6;
            pointer-events: none;
        }

        .disabled-section .skin-btn {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
        }

        .disabled-section .skin-btn:hover {
            background: #333333;
        }

        .disabled-section .skin-btn:active {
            background: #333333;
        }

        /* 新增角色养成模块样式 */
        .character-development-input {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 6px 0;
            padding: 8px 12px;
            background: #333333; /* 深灰色背景 */
            border-radius: 6px;
            border: 1px solid #444444;
            gap: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .character-development-label {
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            flex-wrap: nowrap;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .character-development-value {
            font-weight: bold;
            color: #FF4500; /* 橙红色 */
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
            white-space: nowrap;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .character-development-controls input {
            padding: 8px;
            border: 1px solid #555555;
            border-radius: 5px;
            width: 70px;
            text-align: center;
            font-size: 14px;
            min-width: 0;
            flex-shrink: 0;
            background: #2a2a2a;
            color: #FFFFFF;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .character-development-btn {
            width: 100%;
            padding: 10px;
            border: 2px solid #555555;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            margin-top: 10px;
            color: #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .character-development-btn:hover {
            border-color: #FF4500;
            background: #3a3a3a;
            color: #FFFFFF;
        }

        .character-development-btn.active {
            border-color: #FF4500;
            background: #8B0000; /* 深红色 */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        /* 饼状图样式 */
        .pie-chart-section {
            background: #2a2a2a; /* 深灰色背景 */
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #333333;
            margin-bottom: 20px;
            position: relative;
            min-height: 320px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), 
                        inset 0 0 0 1px rgba(255, 107, 107, 0.2);
        }

        /* 饼状图容器布局 */
        .pie-chart-container {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* 饼状图画布包装器 */
        .pie-canvas-wrapper {
            position: relative;
            width: 60%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 饼状图画布 */
        .pie-canvas {
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.2s ease;
        }

        .pie-canvas:hover {
            transform: scale(1.02);
        }

        /* 饼状图提示框 */
        .pie-tooltip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            pointer-events: none;
            text-align: center;
            min-width: 120px;
            border: 1px solid #FF4500;
        }

        .tooltip-details {
            font-size: 11px;
            margin-top: 4px;
            color: #FF6B6B;
        }

        /* 饼状图图例 */
        .pie-legend {
            flex: 1;
            padding: 12px;
            background: #333333; /* 深灰色背景 */
            border-radius: 8px;
            border: 1px solid #444444;
            max-height: 250px;
            overflow-y: auto;
            box-sizing: border-box;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            transform: translateX(5px);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .legend-text {
            font-size: 12px;
            color: #CCCCCC;
        }

        .legend-total {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444444;
            font-size: 13px;
            font-weight: bold;
            color: #FF6B6B; /* 亮红色 */
            text-align: left;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        /* 移动端适配 */
        @media (max-width: 768px) {

            /* 新增：异方晶修正输入框移动端适配 */
            .resource-input {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            
            .resource-input label {
                min-width: auto !important;
                margin-bottom: 5px !important;
            }
            
            .resource-input input {
                width: 100% !important;
                max-width: 120px !important;
            }
            
            /* 专门针对异方晶修正输入框的样式 */
            .custom-adjust .resource-input input {
                max-width: 120px !important;
            }

            .gacha-calculator {
                padding: 10px;
            }
            
            .calculator-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .sticky-panel {
                position: sticky;
                top: 10px;
                z-index: 100;
                background: #2a2a2a; /* 深灰色背景 */
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                margin-bottom: 15px;
            }

            /* 其他移动端样式保持不变，只调整颜色 */
            .time-options {
                flex-direction: row;
                gap: 8px;
            }

            .time-option {
                padding: 10px;
            }

            .time-title {
                font-size: 13px;
            }

            .time-date {
                font-size: 11px;
            }

            .time-days {
                font-size: 13px;
            }

            .time-weeks {
                font-size: 11px;
            }
            
            .card {
                padding: 15px;
            }
            
            .resource-vertical {
                gap: 10px;
            }
            
            .resource-input-vertical {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .resource-input-vertical label {
                min-width: auto;
            }
            
            .resource-input-vertical input {
                width: 100%;
                max-width: 120px;
            }
            
            .skin-reserve-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .dark-zone-switches {
                flex-direction: column;
                gap: 8px;
                width: 100%;
                margin-top: 8px;
            }
            
            .target-buttons {
                grid-template-columns: 1fr;
            }
            
            .rating-buttons {
                grid-template-columns: 1fr;
            }
            
            .target-btn, .rating-btn {
                font-size: 12px;
                padding: 8px 6px;
            }

            /* 新增模块移动端适配 */
            .main-story-columns {
                grid-template-columns: 1fr;
            }

            .main-story-btn {
                font-size: 11px;
                padding: 8px 6px;
            }

            /* 狄斯暗影（EX）移动端适配 */
            .ex-columns {
                grid-template-columns: 1fr;
            }

            .ex-btn {
                font-size: 11px;
                padding: 8px 6px;
            }

            .memory-storm-buttons,
            .pollution-nest-buttons,
            .cleanup-operation-buttons {
                grid-template-columns: 1fr;
            }

            .memory-storm-btn,
            .pollution-nest-btn,
            .cleanup-operation-btn {
                font-size: 12px;
                padding: 8px 6px;
            }

            .palma-ruins-row {
                grid-template-columns: 1fr;
            }

            .palma-ruins-btn {
                font-size: 12px;
                padding: 8px 6px;
            }
            
            .resource-input {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .resource-input label {
                width: auto;
                margin-bottom: 5px;
            }
            
            .time-options {
                grid-template-columns: 1fr;
            }
            
            .accumulation-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .switch-group.small {
                margin: 5px 0 0 0;
            }
            
            .item-info {
                width: 100%;
                margin-bottom: 8px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .certification-controls {
                margin-top: 8px;
                width: 100%;
                justify-content: center;
            }
                    
            .training-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            /* 专门针对活动模块中的复刻按钮调整 */
            .accumulation-item .training-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-top: 10px;
            }
            
            .accumulation-item .training-btn {
                font-size: 12px;
                padding: 10px 6px;
                min-height: auto;
                white-space: normal;
                line-height: 1.3;
            }
            
            .summary-section {
                padding: 10px;
            }
            
            .summary-item {
                font-size: 14px;
            }
            
            .resource-icon {
                width: 22px;
                height: 22px;
            }
            
            .resource-icon.small {
                width: 18px;
                height: 18px;
            }

            /* 角色养成模块移动端适配 */
            .character-development-input {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                padding: 10px;
            }

            .character-development-label {
                display: flex;
                align-items: center;
                gap: 4px;
                flex: 1;
                flex-wrap: wrap;
            }

            .character-development-value {
                margin-left: 4px;
                white-space: nowrap;
            }

            .character-development-controls {
                align-self: center;
                flex-shrink: 0;
            }

            .character-development-controls input {
                width: 65px;
            }

            /* 饼状图768px适配样式 - 修改图例为2列显示并放大字体 */
            .pie-chart-container {
                flex-direction: column !important;
                gap: 15px !important;
                align-items: center !important;
            }

            .pie-canvas-wrapper {
                width: 100% !important;
                height: 200px !important;
            }

            .pie-legend {
                width: 100% !important;
                max-height: 180px !important; /* 增加高度适应更大字体 */
                margin-top: 10px !important;
                justify-content: flex-start !important;
                padding: 12px !important; /* 增加内边距 */
            }

            .pie-canvas {
                width: 100% !important;
                height: 100% !important;
            }

            /* 图例项改为2列网格布局 */
            .legend-items {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important; /* 2列布局 */
                gap: 10px !important; /* 增加间距 */
            }

            .legend-item {
                margin-bottom: 8px !important; /* 增加间距 */
                display: flex !important;
                align-items: center !important;
                min-height: 20px !important; /* 确保有足够高度 */
            }

            .legend-text {
                font-size: 13px !important; /* 放大字体 */
                line-height: 1.3 !important; /* 增加行高 */
                font-weight: 500 !important; /* 稍微加粗 */
            }

            .legend-color {
                width: 14px !important; /* 增大颜色块 */
                height: 14px !important; /* 增大颜色块 */
                margin-right: 8px !important; /* 增加右边距 */
            }

            .character-development-label {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                flex-direction: row;
            }

            .character-development-controls {
                align-self: center;
            }

            .module-toggle {
                margin-left: 0;
                margin-top: 5px;
            }

            /* 饼状图768px适配样式 */
            .pie-chart-container {
                flex-direction: column !important;
                gap: 15px !important;
                align-items: center !important;
            }

            .pie-canvas-wrapper {
                width: 100% !important;
                height: 200px !important;
            }

            .pie-legend {
                width: 100% !important;
                max-height: 150px !important;
                margin-top: 10px !important;
                justify-content: flex-start !important;
            }

            .pie-canvas-wrapper {
                width: 100% !important;
                height: 200px !important;
            }

            .pie-canvas {
                width: 100% !important;
                height: 100% !important;
            }

            .pie-legend {
                width: 100% !important;
                padding: 10px !important;
            }

            .legend-items {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .legend-item {
                margin-bottom: 5px !important;
            }

            .legend-text {
                font-size: 11px !important;
            }
        }

        @media (max-width: 480px) {

            /* 新增：小屏幕异方晶修正输入框适配 */
            .custom-adjust .resource-input input {
                max-width: 100px !important;
                font-size: 14px !important;
            }
            
            .custom-adjust .resource-input label {
                font-size: 14px !important;
            }

            .training-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
            
            /* 专门针对活动模块中的复刻按钮调整 */
            .accumulation-item .training-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin-top: 8px;
            }
            
            .accumulation-item .training-btn {
                font-size: 11px;
                padding: 8px 4px;
                min-height: auto;
                white-space: normal;
                line-height: 1.2;
            }
            
            /* 调整复刻按钮中的图标大小 */
            .accumulation-item .training-btn .resource-icon {
                width: 16px;
                height: 16px;
            }

            .character-development-input {
                padding: 8px 10px;
                gap: 8px;
            }

            .character-development-label {
                font-size: 13px;
                gap: 3px;
            }

            .character-development-value {
                font-size: 13px;
                margin-left: 3px;
            }

            .character-development-controls input {
                width: 60px;
                padding: 6px;
                font-size: 13px;
            }

            .resource-icon {
                width: 18px;
                height: 18px;
            }

            .gacha-calculator {
                padding: 5px;
            }
            
            .card {
                padding: 10px;
            }
            
            .time-title {
                font-size: 12px;
            }
            
            .time-date {
                font-size: 10px;
            }
            
            .time-days {
                font-size: 12px;
            }
            
            .time-weeks {
                font-size: 10px;
            }
            
            .time-option {
                padding: 8px;
            }

            .resource-input input {
                width: 100%;
            }
            
            .switch-group {
                flex-wrap: wrap;
            }
            
            .result-item.simple {
                font-size: 16px;
            }
            
            .result-item.highlight {
                font-size: 18px;
            }
            
            .sub-section {
                padding: 10px;
            }
            
            .summary-item {
                font-size: 13px;
            }
            
            .resource-input-vertical label {
                font-size: 13px;
            }
            
            .skin-item.compact {
                padding: 8px;
            }
            
            .target-btn, .rating-btn {
                font-size: 11px;
                padding: 6px 4px;
            }

            /* 新增模块小屏幕适配 */
            .main-story-btn {
                font-size: 10px;
                padding: 6px 4px;
            }

            /* 饼状图480px适配样式 */
            .pie-chart-section {
                padding: 8px !important;
                min-height: 250px !important;
            }

            .pie-chart-section h3 {
                font-size: 14px !important;
                margin-bottom: 8px !important;
            }

            .pie-canvas-wrapper {
                height: 180px !important;
            }

            .legend-items {
                grid-template-columns: 1fr !important;
            }

            .legend-text {
                font-size: 10px !important;
            }

            .legend-total {
                font-size: 12px !important;
            }

            /* 狄斯暗影（EX）小屏幕适配 */
            .ex-btn {
                font-size: 10px;
                padding: 6px 4px;
            }

            .memory-storm-btn,
            .pollution-nest-btn,
            .cleanup-operation-btn,
            .palma-ruins-btn {
                font-size: 11px;
                padding: 6px 4px;
            }
            
            .resource-icon {
                width: 20px;
                height: 20px;
            }
            
            .resource-icon.small {
                width: 16px;
                height: 16px;
            }

            /* 饼状图480px适配样式 */
            .pie-chart-section {
                padding: 8px !important;
                min-height: 250px !important;
            }

            .pie-canvas-wrapper {
                height: 180px !important;
            }

            .legend-items {
                grid-template-columns: 1fr !important;
            }

            .legend-text {
                font-size: 10px !important;
            }

            .legend-total {
                font-size: 12px !important;
            }
    
            /* 新增：小屏幕饼状图图例优化 */
            .pie-legend {
                max-height: 160px !important; /* 适当增加高度 */
                padding: 8px !important; /* 增加内边距 */
            }

            .legend-items {
                grid-template-columns: 1fr 1fr !important; /* 保持2列布局 */
                gap: 6px !important; /* 适当间距 */
            }

            .legend-item {
                margin-bottom: 4px !important;
                padding: 2px 4px !important; /* 增加内边距 */
            }

            .legend-text {
                font-size: 11px !important; /* 比原来大，但比768px的小 */
                line-height: 1.2 !important;
            }

            .legend-color {
                width: 12px !important;
                height: 12px !important;
                margin-right: 6px !important;
            }
            
            .legend-total {
                font-size: 12px !important; /* 放大字体 */
                margin-top: 12px !important; /* 增加上边距 */
                padding-top: 8px !important; /* 增加上内边距 */
                font-weight: bold !important; /* 加粗 */
                grid-column: 1 / -1 !important; /* 跨两列显示 */
                text-align: center !important; /* 居中对齐 */
            }
        }

        @media (max-width: 360px) {
            .pie-chart-container {
                flex-direction: column !important;
                gap: 10px !important;
            }
        }

        /* 饼状图canvas样式 */
        .pie-chart-section canvas {
            transition: transform 0.2s ease;
        }

        .pie-chart-section canvas:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="gacha-calculator">
            <h1><img :src="hlIcon" class="resource-icon" alt="海拉" style="width: 40px; height: 40px;"> 海拉的钱包</h1>
            
            <div class="calculator-layout">
                <!-- 左侧：卡池时间和攒抽预测 -->
                <div class="left-panel sticky-panel">
                    <!-- 合并的卡池时间和攒抽预测模块 -->
                    <div class="time-section card">
                        <h2 @click="toggleSection('pullSummary')" class="section-header">
                            📊 共计 {{ totalModulePulls }} 抽 💰氪金{{ totalRechargeCost }}￥
                            <span class="collapse-icon">{{ sections.pullSummary ? '−' : '+' }}</span>
                        </h2>
                        
                    <!-- 资源信息 - 始终显示 -->
                    <div class="summary-section" style="display: flex; justify-content: space-around; align-items: center; gap: 15px;">
                        <div class="summary-item" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <span class="summary-value">{{ totalCrystalSummary }}</span>
                                <div style="font-size: 12px; color: #666;">({{ Math.floor(totalCrystalSummary / 180) }}抽)</div>
                            </div>
                        </div>
                        <div class="summary-item" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <img :src="premiumCrystalIcon" class="resource-icon" alt="璀璨晶源">
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <span class="summary-value">{{ totalPremiumCrystalSummary }}</span>
                                <div style="font-size: 12px; color: #666;">({{ Math.floor(totalPremiumCrystalSummary / 180) }}抽)</div>
                            </div>
                        </div>
                        <div class="summary-item" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <img :src="ticketIcon" class="resource-icon" alt="搜索令">
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <span class="summary-value">{{ totalTicketsSummary }}</span>
                                <div style="font-size: 12px; color: #666;">({{ totalTicketsSummary }}抽)</div>
                            </div>
                        </div>
                        <div class="summary-item" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <img :src="limitedCouponIcon" class="resource-icon" alt="限定券">
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <span class="summary-value">{{ totalLimitedCouponsSummary }}</span>
                                <div style="font-size: 12px; color: #666;">({{ totalLimitedCouponsSummary }}抽)</div>
                            </div>
                        </div>
                    </div>

                            <!-- 详细内容 - 可折叠 -->
                            <div v-if="sections.pullSummary" class="section-content">
                                <!-- 卡池时间内容 -->
                                <div class="switch-group">
                                    <span class="switch-label" :class="{ active: !calculateToPoolEnd, inactive: calculateToPoolEnd }">计算到卡池开放当天</span>
                                    <label class="switch">
                                        <input type="checkbox" v-model="calculateToPoolEnd">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label" :class="{ active: calculateToPoolEnd, inactive: !calculateToPoolEnd }">计算到卡池结束当天</span>
                                </div>
                                
                                <!-- 新增饼状图 -->
                                <div class="pie-chart-section">
                                    <h3 style="text-align: center; margin-bottom: 15px; color: #FF6B6B;">各模块抽数占比</h3>
                                    
                                    <div class="pie-chart-container">
                                        <!-- 饼状图容器 -->
                                        <div class="pie-canvas-wrapper">
                                            <canvas 
                                                ref="pieChart" 
                                                @mousemove="handlePieChartMouseMove"
                                                @mouseleave="handlePieChartMouseLeave"
                                                @touchstart="handlePieChartTouchStart"
                                                @touchmove="handlePieChartTouchMove"
                                                @touchend="handlePieChartTouchEnd"
                                                class="pie-canvas"
                                            ></canvas>
                                            
                                            <!-- 悬停提示框 -->
                                            <div v-if="hoveredPieModule" class="pie-tooltip">
                                                <div>{{ hoveredPieModule.name }}</div>
                                                <div class="tooltip-details">
                                                    {{ hoveredPieModule.pulls }}抽 ({{ hoveredPieModule.percentage }}%)
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 图例 - 响应式布局 -->
                                        <div class="pie-legend">
                                            <div class="legend-items">
                                                <div v-for="(module, index) in pieChartData" :key="module.name" class="legend-item">
                                                    <div class="legend-color" :style="{ backgroundColor: module.color }"></div>
                                                    <span class="legend-text">
                                                        {{ module.name }}: {{ module.pulls }}抽 ({{ module.percentage }}%)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="time-options">
                                    <div class="time-option" 
                                        :class="{ active: selectedTime === 'nextVersion' }"
                                        @click="selectedTime = 'nextVersion'">
                                        <div class="time-header">
                                            <div class="time-title">主线版本</div>
                                            <div class="time-days">倒计时 {{ calculateDisplayDays('nextVersion') }} 天</div>
                                        </div>
                                        <div class="time-date">{{ formattedNextVersionDate }}</div>
                                    </div>

                                    <div class="time-option" 
                                        :class="{ active: selectedTime === 'newYear' }"
                                        @click="selectedTime = 'newYear'">
                                        <div class="time-header">
                                            <div class="time-title">新年版本</div>
                                            <div class="time-days">倒计时 {{ calculateDisplayDays('newYear') }} 天</div>
                                        </div>
                                        <div class="time-date">{{ formattedNewYearDate }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- 右侧：当前资源和日常积累 -->
                <div class="right-panel">
                    <!-- 当前资源 -->
                    <div class="input-section card">
                        <h2 @click="toggleSection('resources')" class="section-header">
                            💎 当前资源
                            <span class="collapse-icon">{{ sections.resources ? '−' : '+' }}</span>
                        </h2>
                        <div v-if="sections.resources" class="section-content">
                            <!-- 当前库存 - 修改为垂直布局 -->
                            <div class="sub-section">
                                <h3 class="sub-title">当前库存</h3>
                                <!-- 使用璀璨晶源开关移入当前库存 -->
                                <div class="switch-group">
                                    <label class="switch">
                                        <input type="checkbox" v-model="usePremiumCrystal">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label">使用璀璨晶源抽卡</span>
                                </div>
                                <div class="resource-vertical">
                                    <div class="resource-input-vertical">
                                        <label>
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> 异方晶：
                                        </label>
                                        <input type="number" v-model.number="resources.crystal" placeholder="" min="0" step="1" @input="validateInput('crystal')" @focus="clearIfZero('crystal')" @blur="setDefaultIfEmpty('crystal')">
                                    </div>
                                    <div class="resource-input-vertical">
                                        <label>
                                            <img :src="premiumCrystalIcon" class="resource-icon" alt="璀璨晶源"> 璀璨晶源：
                                        </label>
                                        <input type="number" v-model.number="resources.premiumCrystal" placeholder="" min="0" step="1" @input="validateInput('premiumCrystal')" @focus="clearIfZero('premiumCrystal')" @blur="setDefaultIfEmpty('premiumCrystal')">
                                    </div>
                                    <div class="resource-input-vertical">
                                        <label>
                                            <img :src="ticketIcon" class="resource-icon" alt="搜索令"> 搜索令：
                                        </label>
                                        <input type="number" v-model.number="resources.tickets" placeholder="" min="0" step="1" @input="validateInput('tickets')" @focus="clearIfZero('tickets')" @blur="setDefaultIfEmpty('tickets')">
                                    </div>
                                </div>
                            </div>

                            <!-- 皮肤预留红晶 - 修改按键布局 -->
                            <div class="sub-section" :class="{ 'disabled-section': !usePremiumCrystal }">
                                <h3 class="sub-title">皮肤预留红晶</h3>
                                <div class="skin-reserve-row">
                                    <div class="skin-item compact">
                                        <div class="skin-info">
                                            <span class="skin-price">✧✧880<img :src="redCrystalIcon" class="resource-icon small" alt="红晶"></span>
                                        </div>
                                        <div class="skin-controls">
                                            <button class="skin-btn" @click="adjustSkinCount(880, -1)" :disabled="!usePremiumCrystal">−</button>
                                            <span class="skin-count">{{ skinReserve.skin880 }} 个</span>
                                            <button class="skin-btn" @click="adjustSkinCount(880, 1)" :disabled="!usePremiumCrystal">+</button>
                                        </div>
                                    </div>
                                    <div class="skin-item compact">
                                        <div class="skin-info">
                                            <span class="skin-price">✧✧✧1280<img :src="redCrystalIcon" class="resource-icon small" alt="红晶"></span>
                                        </div>
                                        <div class="skin-controls">
                                            <button class="skin-btn" @click="adjustSkinCount(1280, -1)" :disabled="!usePremiumCrystal">−</button>
                                            <span class="skin-count">{{ skinReserve.skin1280 }} 个</span>
                                            <button class="skin-btn" @click="adjustSkinCount(1280, 1)" :disabled="!usePremiumCrystal">+</button>
                                        </div>
                                    </div>
                                    <div class="skin-item compact">
                                        <div class="skin-info">
                                            <span class="skin-price">✧✧✧✧2580<img :src="redCrystalIcon" class="resource-icon small" alt="红晶"></span>
                                        </div>
                                        <div class="skin-controls">
                                            <button class="skin-btn" @click="adjustSkinCount(2580, -1)" :disabled="!usePremiumCrystal">−</button>
                                            <span class="skin-count">{{ skinReserve.skin2580 }} 个</span>
                                            <button class="skin-btn" @click="adjustSkinCount(2580, 1)" :disabled="!usePremiumCrystal">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 自定义修正 -->
                            <div class="sub-section">
                                <h3 class="sub-title">自定义修正</h3>
                                <div class="custom-adjust">
                                    <div class="resource-input">
                                        <label style="min-width: 140px; flex-shrink: 0;">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">异方晶修正：
                                        </label>
                                        <input type="number" v-model.number="customAdjustment" placeholder="0" style="max-width: 120px;">
                                    </div>
                                    <div class="custom-tip">
                                        例如给关卡未打满、复刻池预留、其它异方晶来源等，可填负数
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 日常积累 -->
                    <div class="daily-section card">
                        <h2 @click="toggleSection('daily')" class="section-header">
                            📈 日常积累（更替）
                            <span class="collapse-icon">{{ sections.daily ? '−' : '+' }}</span>
                        </h2>
                        <div v-if="sections.daily" class="section-content">
                            <!-- 活跃奖励模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">活跃奖励</h3>
                                <!-- 日常活跃 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">日常{{ selectedDays }}天：</span>
                                        <span class="item-value"><img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ dailyActiveTotal }} </span>
                                    </div>
                                </div>

                                <!-- 周常活跃 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">周常{{ remainingWeeklyCount }}周：</span>
                                        <span class="item-value"><img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ remainingWeeklyTotal }} </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="weeklyCompleted">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本周已完成</span>
                                    </div>
                                </div>

                                <!-- 每周分享 - 位置调整到情绪检测上方 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">分享{{ remainingShareWeeks }}周：</span>
                                        <span class="item-value"> <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ remainingShareTotal }} </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="dailyShareCompleted">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本周已分享</span>
                                    </div>
                                </div>

                                <!-- 情绪检测 - 位置调整到每周分享下方 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">情绪检测{{ emotionDetectionCompleted ? (remainingMonths - 1) : remainingMonths }}月：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">{{ totalEmotionDetection }} <img :src="ticketIcon" class="resource-icon" alt="搜索令">{{ totalEmotionDetectionTickets }}
                                        </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="emotionDetectionCompleted">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本月已完成</span>
                                    </div>
                                </div>

                                <!-- 签到奖励 - 新增模块 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">签到奖励{{ signInRewardCompleted ? (remainingMonths - 1) : remainingMonths }}月：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">{{ totalSignInReward }} <img :src="ticketIcon" class="resource-icon" alt="搜索令">{{ totalSignInRewardTickets }}
                                        </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="signInRewardCompleted">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本月已完成</span>
                                    </div>
                                </div>

                                <!-- 监察密令模块 - 整合到背景框中 -->
                                <div class="nightmare-score" style="margin-top: 20px;">
                                    
                                <button 
                                    class="training-btn" 
                                    style="width: 100%; margin-bottom: 15px; background: #3c3a3a; cursor: default;"
                                    disabled>
                                    经历{{ calculateInspectionPeriods }}期监察密令
                                    <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ dailyInspectionOrderTickets }}
                                </button>
                                    
                                    <div class="slider-container">
                                        <div class="slider-labels">
                                            <span>0级</span>
                                            <span>55级</span>
                                        </div>
                                        <input 
                                            type="range" 
                                            v-model.number="dailyInspectionOrderLevel" 
                                            min="0" 
                                            max="55"
                                            step="5"
                                            class="inspection-slider"
                                        >
                                        <datalist id="inspection-levels">
                                            <option value="0">0</option>
                                            <option value="5">5</option>
                                            <option value="15">15</option>
                                            <option value="25">25</option>
                                            <option value="30">30</option>
                                            <option value="35">35</option>
                                            <option value="45">45</option>
                                            <option value="50">50</option>
                                            <option value="55">55</option>
                                        </datalist>
                                        <div class="slider-value">
                                            本期监察密令等级: {{ dailyInspectionOrderLevel }}
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- 破碎防线模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">破碎防线</h3>
                                <!-- 暗域 -->
                                <div class="dark-zone-section">
                                    <div class="accumulation-item">
                                        <div class="item-info">
                                            <span class="item-title">暗域{{ remainingDarkZoneWeeks }}周：</span>
                                            <span class="item-value"> <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ remainingDarkZoneTotal }}</span>
                                        </div>
                                        <div class="dark-zone-switches">
                                            <div class="switch-group small">
                                                <label class="switch">
                                                    <input type="checkbox" v-model="darkZoneSweepOnly">
                                                    <span class="slider"></span>
                                                </label>
                                                <span class="switch-label">仅扫荡</span>
                                            </div>
                                            <div class="switch-group small">
                                                <label class="switch">
                                                    <input type="checkbox" v-model="darkZoneCompleted">
                                                    <span class="slider"></span>
                                                </label>
                                                <span class="switch-label">本周已完成</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accumulation-item">
                                        <div class="item-info">
                                            <span class="item-title">首通奖励：</span>
                                            <span class="item-value"> <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ totalDarkZoneFirst }}</span>
                                        </div>
                                        <div class="switch-group small">
                                            <label class="switch">
                                                <input type="checkbox" v-model="darkZoneFirstCompleted">
                                                <span class="slider"></span>
                                            </label>
                                            <span class="switch-label">本期已完成</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 数据间隙模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">数据间隙-上半赛季</h3>
                                
                                <!-- 目标奖励子模块 -->
                                <div class="data-gap-subsection">
                                    <h4 class="data-gap-title">目标奖励-L1</h4>
                                    <div class="target-buttons">
                                        <button 
                                            class="target-btn" 
                                            :class="{ active: dataGap.targets.missionComplete }"
                                            @click="toggleDataGap('targets', 'missionComplete')">
                                            完成关卡<img :src="crystalIcon" class="resource-icon" alt="异方晶">300
                                        </button>
                                        <button 
                                            class="target-btn" 
                                            :class="{ active: dataGap.targets.missionCount }"
                                            @click="toggleDataGap('targets', 'missionCount')">
                                            完成关卡数量<img :src="crystalIcon" class="resource-icon" alt="异方晶">120
                                        </button>
                                        <button 
                                            class="target-btn" 
                                            :class="{ active: dataGap.targets.targetComplete }"
                                            @click="toggleDataGap('targets', 'targetComplete')">
                                            目标完成数量<img :src="crystalIcon" class="resource-icon" alt="异方晶">140
                                        </button>
                                    </div>
                                </div>

                                <!-- 评分奖励子模块 -->
                                <div class="data-gap-subsection">
                                    <h4 class="data-gap-title">评分奖励-L2</h4>
                                    <div class="rating-buttons">
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.healing }"
                                            @click="toggleDataGap('ratings', 'healing')">
                                            单位治疗量<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.shield }"
                                            @click="toggleDataGap('ratings', 'shield')">
                                            单位护盾量<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.controlTime }"
                                            @click="toggleDataGap('ratings', 'controlTime')">
                                            控制时长积分<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.controlCount }"
                                            @click="toggleDataGap('ratings', 'controlCount')">
                                            控制次数<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.totalDamage }"
                                            @click="toggleDataGap('ratings', 'totalDamage')">
                                            总伤害<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.coreDamage }"
                                            @click="toggleDataGap('ratings', 'coreDamage')">
                                            破核期间伤害<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                        <button 
                                            class="rating-btn" 
                                            :class="{ active: dataGap.ratings.comprehensive }"
                                            @click="toggleDataGap('ratings', 'comprehensive')">
                                            综合评分<img :src="crystalIcon" class="resource-icon" alt="异方晶">100
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 狂厄特训模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">狂厄特训</h3>
                                <div class="training-buttons">
                                    <button 
                                        class="training-btn" 
                                        :class="{ active: trainingModes.steady }"
                                        @click="toggleTrainingMode('steady')">
                                        平稳<img :src="crystalIcon" class="resource-icon" alt="异方晶">100<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                    </button>
                                    <button 
                                        class="training-btn" 
                                        :class="{ active: trainingModes.fluctuating }"
                                        @click="toggleTrainingMode('fluctuating')">
                                        波动<img :src="crystalIcon" class="resource-icon" alt="异方晶">200<img :src="ticketIcon" class="resource-icon" alt="搜索令">2
                                    </button>
                                    <button 
                                        class="training-btn" 
                                        :class="{ active: trainingModes.outOfControl }"
                                        @click="toggleTrainingMode('outOfControl')">
                                        失控<img :src="crystalIcon" class="resource-icon" alt="异方晶">200
                                    </button>
                                    <button 
                                        class="training-btn" 
                                        :class="{ active: trainingModes.crazy }"
                                        @click="toggleTrainingMode('crazy')">
                                        疯狂<img :src="crystalIcon" class="resource-icon" alt="异方晶">60
                                    </button>
                                </div>
                            </div>

                            <!-- 祸海之厄模块 - 移入日常积累 -->
                            <div class="sub-section">
                                <h3 class="sub-title">无尽梦魇</h3>
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">祸海之厄：</span>
                                        <span class="item-value"> <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ nightmareSeaReward }}</span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="nightmareSeaCompleted">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本期已完成</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 商店兑换 -->
                            <div class="shop-section">
                                <div class="shop-title">商店兑换</div>
                                
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">追踪认证-常规：</span>
                                        <span class="item-value"> <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ remainingTrackingExchange }}</span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="trackingExchanged">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本月已兑换</span>
                                    </div>
                                </div>

                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">追踪认证-机密：</span>
                                        <span class="item-value"> <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ trackingCertificationTickets }}</span>
                                    </div>
                                    <div class="certification-controls">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input 
                                                type="number" 
                                                v-model.number="trackingCertificationCount" 
                                                placeholder="0" 
                                                min="0" 
                                                step="1" 
                                                @input="validateCertificationInput"
                                                style="width: 80px; padding: 8px; border: 1px solid #555555; border-radius: 5px; text-align: center; background: #333333; color: #FFFFFF; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);"
                                            >
                                            <img :src="yellowTicketIcon" class="resource-icon" alt="黄票">
                                        </div>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="useTrackingCertification">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">使用黄票兑换</span>
                                    </div>
                                </div>

                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">友情兑换：</span>
                                        <span class="item-value"> <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ remainingFriendshipExchange }}</span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="friendshipExchanged">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本月已兑换</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 潜在资源模块 -->
                    <div class="potential-section card">
                        <h2 @click="toggleSection('potential')" class="section-header">
                            🔮 潜在资源（常驻）
                            <span class="collapse-icon">{{ sections.potential ? '−' : '+' }}</span>
                        </h2>
                        <div v-if="sections.potential" class="section-content">
                            <!-- 无尽梦魇子模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">无尽梦魇</h3>
                                
                                <!-- 积分奖励 -->
                                <div class="nightmare-score">
                                    <h4 class="score-title">
                                        积分奖励 
                                        <span style="font-size: 14px; font-weight: normal; margin-left: 10px;">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ nightmareRemainingCrystal }} 
                                            <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ nightmareTicketReward }}
                                        </span>
                                    </h4>
                                    <div class="slider-container">
                                        <div class="slider-labels">
                                            <span>0</span>
                                            <span>60000</span>
                                        </div>
                                        <input 
                                            type="range" 
                                            v-model.number="nightmareScore" 
                                            min="0" 
                                            max="60000" 
                                            step="1000"
                                            class="score-slider"
                                        >
                                        <div class="slider-value">
                                            当前积分: {{ nightmareScore }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 角色养成模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">角色养成</h3>
                                
                                <div class="character-development-input">
                                    <span class="character-development-label">
                                        未3阶角色数量：
                                        <span class="character-development-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ characterDevelopment.tier3 * 180 }}
                                        </span>
                                    </span>
                                    <div class="character-development-controls">
                                        <input type="number" v-model.number="characterDevelopment.tier3" placeholder="0" min="0" step="1" @input="validateCharacterDevInput('tier3')" @focus="clearCharacterDevIfZero('tier3')" @blur="setCharacterDevDefaultIfEmpty('tier3')">
                                    </div>
                                </div>

                                <div class="character-development-input">
                                    <span class="character-development-label">
                                        未满混响狂级角色数量：
                                        <span class="character-development-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ characterDevelopment.maxReverbS * 210 }}
                                        </span>
                                    </span>
                                    <div class="character-development-controls">
                                        <input type="number" v-model.number="characterDevelopment.maxReverbS" placeholder="0" min="0" step="1" @input="validateCharacterDevInput('maxReverbS')" @focus="clearCharacterDevIfZero('maxReverbS')" @blur="setCharacterDevDefaultIfEmpty('maxReverbS')">
                                    </div>
                                </div>

                                <div class="character-development-input">
                                    <span class="character-development-label">
                                        未满混响危级角色数量：
                                        <span class="character-development-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ characterDevelopment.maxReverbA * 60 }}
                                        </span>
                                    </span>
                                    <div class="character-development-controls">
                                        <input type="number" v-model.number="characterDevelopment.maxReverbA" placeholder="0" min="0" step="1" @input="validateCharacterDevInput('maxReverbA')" @focus="clearCharacterDevIfZero('maxReverbA')" @blur="setCharacterDevDefaultIfEmpty('maxReverbA')">
                                    </div>
                                </div>

                                <div class="character-development-input">
                                    <span class="character-development-label">
                                        未满混响普级角色数量：
                                        <span class="character-development-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ characterDevelopment.maxReverbB * 20 }}
                                        </span>
                                    </span>
                                    <div class="character-development-controls">
                                        <input type="number" v-model.number="characterDevelopment.maxReverbB" placeholder="0" min="0" step="1" @input="validateCharacterDevInput('maxReverbB')" @focus="clearCharacterDevIfZero('maxReverbB')" @blur="setCharacterDevDefaultIfEmpty('maxReverbB')">
                                    </div>
                                </div>

                                <div class="character-development-input">
                                    <span class="character-development-label">
                                        未审查狂级角色数量：
                                        <span class="character-development-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ characterDevelopment.reviewS * 200 }}
                                        </span>
                                    </span>
                                    <div class="character-development-controls">
                                        <input type="number" v-model.number="characterDevelopment.reviewS" placeholder="0" min="0" step="1" @input="validateCharacterDevInput('reviewS')" @focus="clearCharacterDevIfZero('reviewS')" @blur="setCharacterDevDefaultIfEmpty('reviewS')">
                                    </div>
                                </div>

                                <div class="character-development-input">
                                    <span class="character-development-label">
                                        未审查危级角色数量：
                                        <span class="character-development-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ characterDevelopment.reviewA * 150 }}
                                        </span>
                                    </span>
                                    <div class="character-development-controls">
                                        <input type="number" v-model.number="characterDevelopment.reviewA" placeholder="0" min="0" step="1" @input="validateCharacterDevInput('reviewA')" @focus="clearCharacterDevIfZero('reviewA')" @blur="setCharacterDevDefaultIfEmpty('reviewA')">
                                    </div>
                                </div>
                                
                                <button 
                                    class="character-development-btn" 
                                    :class="{ active: characterDevelopment.haylaReviewed }"
                                    @click="toggleHaylaReview">
                                    {{ characterDevelopment.haylaReviewed ? '已审查海拉！' : '未审查海拉！' }}
                                </button>
                            </div>

                            <!-- 狄斯城（主线） -->
                            <div class="sub-section">
                                <h3 class="sub-title">狄斯城（主线）</h3>
                                <div class="main-story-buttons">
                                    <div class="main-story-columns">
                                        <div class="main-story-column">
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.chaosBeyondA }"
                                                @click="toggleMainStory('chaosBeyondA')">
                                                01混沌彼岸A<img :src="crystalIcon" class="resource-icon" alt="异方晶">995<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.chaosBeyondB }"
                                                @click="toggleMainStory('chaosBeyondB')">
                                                02混沌彼岸B<img :src="crystalIcon" class="resource-icon" alt="异方晶">1230<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.unownedCavernA }"
                                                @click="toggleMainStory('unownedCavernA')">
                                                03无主地窟A<img :src="crystalIcon" class="resource-icon" alt="异方晶">1175<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.unownedCavernB }"
                                                @click="toggleMainStory('unownedCavernB')">
                                                04无主地窟B<img :src="crystalIcon" class="resource-icon" alt="异方晶">1280<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.kiranSquareA }"
                                                @click="toggleMainStory('kiranSquareA')">
                                                05奇兰广场A<img :src="crystalIcon" class="resource-icon" alt="异方晶">1265<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.kiranSquareB }"
                                                @click="toggleMainStory('kiranSquareB')">
                                                06奇兰广场B<img :src="crystalIcon" class="resource-icon" alt="异方晶">1230<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.carnivalA }"
                                                @click="toggleMainStory('carnivalA')">
                                                07嘉年华A<img :src="crystalIcon" class="resource-icon" alt="异方晶">1230<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.carnivalB }"
                                                @click="toggleMainStory('carnivalB')">
                                                08嘉年华B<img :src="crystalIcon" class="resource-icon" alt="异方晶">935<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.refugeeCampA }"
                                                @click="toggleMainStory('refugeeCampA')">
                                                09流民寨A<img :src="crystalIcon" class="resource-icon" alt="异方晶">1125<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                        </div>
                                        <div class="main-story-column">
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.refugeeCampB }"
                                                @click="toggleMainStory('refugeeCampB')">
                                                10流民寨B<img :src="crystalIcon" class="resource-icon" alt="异方晶">1195<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.muddyDarkTrapA }"
                                                @click="toggleMainStory('muddyDarkTrapA')">
                                                11沉浊暗阱A<img :src="crystalIcon" class="resource-icon" alt="异方晶">1230<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.muddyDarkTrapB }"
                                                @click="toggleMainStory('muddyDarkTrapB')">
                                                12沉浊暗阱B<img :src="crystalIcon" class="resource-icon" alt="异方晶">605<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.highTowerBlackRing }"
                                                @click="toggleMainStory('highTowerBlackRing')">
                                                13高塔黑环<img :src="crystalIcon" class="resource-icon" alt="异方晶">1980<img :src="ticketIcon" class="resource-icon" alt="搜索令">2
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.darkSurgeA }"
                                                @click="toggleMainStory('darkSurgeA')">
                                                N1暗涌A<img :src="crystalIcon" class="resource-icon" alt="异方晶">1005<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.darkSurgeB }"
                                                @click="toggleMainStory('darkSurgeB')">
                                                N2暗涌B<img :src="crystalIcon" class="resource-icon" alt="异方晶">1005<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.goldFeastA }"
                                                @click="toggleMainStory('goldFeastA')">
                                                N3碎金盛宴A<img :src="crystalIcon" class="resource-icon" alt="异方晶">900<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                            <button 
                                                class="main-story-btn" 
                                                :class="{ active: mainStory.goldFeastB }"
                                                @click="toggleMainStory('goldFeastB')">
                                                N4碎金盛宴B<img :src="crystalIcon" class="resource-icon" alt="异方晶">1180<img :src="ticketIcon" class="resource-icon" alt="搜索令">1
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 行动纪要模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">行动纪要</h3>
                                <div class="action-summary">
                                    <div class="summary-header" style="background: #2a2a2a; padding: 12px 15px; border-radius: 8px; border: 1px solid #e1e5e9; margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <span class="summary-text" style="font-size: 16px; font-weight: bold; color: #FF4500; flex: 1;">
                                                {{ actionSummaryText }}
                                            </span>
                                            <span class="summary-crystal" style="font-size: 14px; font-weight: bold; color: #1890ff; white-space: nowrap;">
                                                <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ actionSummaryCrystal }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="slider-container">
                                        <input 
                                            type="range" 
                                            v-model.number="actionSummaryLevel" 
                                            min="0" 
                                            max="19"
                                            step="1"
                                            class="score-slider"
                                        >
                                        <div class="slider-value">
                                            当前状态: {{ actionSummaryText }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 狄斯暗影（EX） -->
                            <div class="sub-section">
                                <h3 class="sub-title">狄斯暗影（EX）</h3>
                                <div class="ex-buttons">
                                    <div class="ex-columns">
                                        <div class="ex-column">
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.chaosBeyond }"
                                                @click="toggleDarkShadowEx('chaosBeyond')">
                                                EX01混沌彼岸·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">720
                                            </button>
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.unownedCavern }"
                                                @click="toggleDarkShadowEx('unownedCavern')">
                                                EX02无主地窟·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">720
                                            </button>
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.kiranSquare }"
                                                @click="toggleDarkShadowEx('kiranSquare')">
                                                EX03奇兰广场·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">590
                                            </button>
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.carnival }"
                                                @click="toggleDarkShadowEx('carnival')">
                                                EX04嘉年华·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">650
                                            </button>
                                        </div>
                                        <div class="ex-column">
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.highTowerBlackRing }"
                                                @click="toggleDarkShadowEx('highTowerBlackRing')">
                                                EX05高塔黑环·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">650
                                            </button>
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.luxuryFeastFog }"
                                                @click="toggleDarkShadowEx('luxuryFeastFog')">
                                                EX06奢宴浓雾·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">650
                                            </button>
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.drowningRainCity }"
                                                @click="toggleDarkShadowEx('drowningRainCity')">
                                                EX07溺雨垂城·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">650
                                            </button>
                                            <button 
                                                class="ex-btn" 
                                                :class="{ active: darkShadowEx.goldFeast }"
                                                @click="toggleDarkShadowEx('goldFeast')">
                                                EX08碎金盛宴·暗影<img :src="crystalIcon" class="resource-icon" alt="异方晶">650
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 记忆风暴 -->
                            <div class="sub-section">
                                <h3 class="sub-title">记忆风暴</h3>
                                <div class="memory-storm-buttons">
                                    <button 
                                        class="memory-storm-btn" 
                                        :class="{ active: memoryStorm.memoryAnomaly }"
                                        @click="toggleMemoryStorm('memoryAnomaly')">
                                        记忆畸点<img :src="crystalIcon" class="resource-icon" alt="异方晶">350
                                    </button>
                                    <button 
                                        class="memory-storm-btn" 
                                        :class="{ active: memoryStorm.impressionAnomaly }"
                                        @click="toggleMemoryStorm('impressionAnomaly')">
                                        印象畸点<img :src="crystalIcon" class="resource-icon" alt="异方晶">350
                                    </button>
                                    <button 
                                        class="memory-storm-btn" 
                                        :class="{ active: memoryStorm.echoAnomaly }"
                                        @click="toggleMemoryStorm('echoAnomaly')">
                                        残响畸点<img :src="crystalIcon" class="resource-icon" alt="异方晶">350
                                    </button>
                                </div>
                            </div>

                            <!-- 污染之巢 -->
                            <div class="sub-section">
                                <h3 class="sub-title">污染之巢</h3>
                                <div class="pollution-nest-buttons">
                                    <button 
                                        class="pollution-nest-btn" 
                                        :class="{ active: pollutionNest.forbiddenZoneProbe }"
                                        @click="togglePollutionNest('forbiddenZoneProbe')">
                                        禁区探查<img :src="crystalIcon" class="resource-icon" alt="异方晶">350
                                    </button>
                                    <button 
                                        class="pollution-nest-btn" 
                                        :class="{ active: pollutionNest.extremeDomainSearch }"
                                        @click="togglePollutionNest('extremeDomainSearch')">
                                        极域搜寻<img :src="crystalIcon" class="resource-icon" alt="异方晶">210
                                    </button>
                                </div>
                            </div>

                            <!-- 清剿行动 -->
                            <div class="sub-section">
                                <h3 class="sub-title">清剿行动</h3>
                                <div class="cleanup-operation-buttons">
                                    <button 
                                        class="cleanup-operation-btn" 
                                        :class="{ active: cleanupOperation.goldRush }"
                                        @click="toggleCleanupOperation('goldRush')">
                                        淘金狂热<img :src="crystalIcon" class="resource-icon" alt="异方晶">350
                                    </button>
                                    <button 
                                        class="cleanup-operation-btn" 
                                        :class="{ active: cleanupOperation.ominousSeed }"
                                        @click="toggleCleanupOperation('ominousSeed')">
                                        恶兆之种<img :src="crystalIcon" class="resource-icon" alt="异方晶">350
                                    </button>
                                </div>
                            </div>

                            <!-- 帕尔马废墟 -->
                            <div class="sub-section">
                                <h3 class="sub-title">帕尔马废墟</h3>
                                <div class="palma-ruins-buttons">
                                    <div class="palma-ruins-row">
                                        <button 
                                            class="palma-ruins-btn" 
                                            :class="{ active: palmaRuins.tenacious }"
                                            @click="togglePalmaRuins('tenacious')">
                                            坚韧<img :src="crystalIcon" class="resource-icon" alt="异方晶">280
                                        </button>
                                        <button 
                                            class="palma-ruins-btn" 
                                            :class="{ active: palmaRuins.berserk }"
                                            @click="togglePalmaRuins('berserk')">
                                            狂暴<img :src="crystalIcon" class="resource-icon" alt="异方晶">280
                                        </button>
                                    </div>
                                    <div class="palma-ruins-row">
                                        <button 
                                            class="palma-ruins-btn" 
                                            :class="{ active: palmaRuins.mysterious }"
                                            @click="togglePalmaRuins('mysterious')">
                                            诡秘<img :src="crystalIcon" class="resource-icon" alt="异方晶">280
                                        </button>
                                        <button 
                                            class="palma-ruins-btn" 
                                            :class="{ active: palmaRuins.precise }"
                                            @click="togglePalmaRuins('precise')">
                                            精准<img :src="crystalIcon" class="resource-icon" alt="异方晶">280
                                        </button>
                                    </div>
                                    <div class="palma-ruins-row">
                                        <button 
                                            class="palma-ruins-btn" 
                                            :class="{ active: palmaRuins.supernatural }"
                                            @click="togglePalmaRuins('supernatural')">
                                            异能<img :src="crystalIcon" class="resource-icon" alt="异方晶">280
                                        </button>
                                        <button 
                                            class="palma-ruins-btn" 
                                            :class="{ active: palmaRuins.inspiration }"
                                            @click="togglePalmaRuins('inspiration')">
                                            启迪<img :src="crystalIcon" class="resource-icon" alt="异方晶">280
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 活动（估算）模块 -->
                    <div class="potential-section card">
                        <h2 @click="toggleSection('activities')" class="section-header">
                            🎯 活动资源（⚠️估算）
                            <span class="collapse-icon">{{ sections.activities ? '−' : '+' }}</span>
                        </h2>
                        <div v-if="sections.activities" class="section-content">
                                <div style="font-size: 12px; color: #666; margin-top: 5px; font-style: italic;">
                                    &nbsp;&nbsp;无准确复刻信息，默认新老活动交替，可自行增减<br>
                                    &nbsp;&nbsp;新老玩家奖励不一致
                                </div>
                            <!-- 动态活动模块 -->
                            <div v-for="activity in displayActivities" :key="activity.title" class="sub-section">
                                <h3 class="sub-title">{{ activity.title }}</h3>
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">活动奖励：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> 
                                            {{ activityCompleted[activity.title] ? 0 : (activity.title === '妄夜迷章' ? 1070 : (activity.title === '主线版本（⚠️估算）' ? 2000 : 1000)) }}
                                            <img :src="ticketIcon" class="resource-icon" alt="搜索令"> 
                                            {{ activityCompleted[activity.title] ? 0 : (activity.title === '主线版本（⚠️估算）' ? 5 : 3) }}
                                        </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="activityCompleted[activity.title]"
                                                @change="toggleActivityCompletion(activity.title)">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本期已完成</span>
                                    </div>
                                </div>
                                
                                <!-- 新增：复刻活动按钮 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <div class="training-buttons" style="margin-top: 10px;">
                                            <button 
                                                class="training-btn" 
                                                :class="{ active: activityRerunMode[activity.title] === 'crystal' }"
                                                @click="setActivityRerunMode(activity.title, 'crystal')"
                                                :disabled="activityRerunMode[activity.title] === 'ticket'">
                                                复刻活动<img :src="crystalIcon" class="resource-icon" alt="异方晶">{{ activityRerunMode[activity.title] === 'crystal' ? 1000 : 0 }}<img :src="ticketIcon" class="resource-icon" alt="搜索令">{{ activityRerunMode[activity.title] === 'crystal' ? 3 : 0 }}
                                            </button>
                                            <button 
                                                class="training-btn" 
                                                :class="{ active: activityRerunMode[activity.title] === 'ticket' }"
                                                @click="setActivityRerunMode(activity.title, 'ticket')"
                                                :disabled="activityRerunMode[activity.title] === 'crystal'">
                                                复刻活动<img :src="ticketIcon" class="resource-icon" alt="搜索令">{{ activityRerunMode[activity.title] === 'ticket' ? 1 : 0 }}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 其他活动奖励项目保持不变 -->
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">审查奖励：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> 
                                            {{ activityReviewCompleted[activity.title] ? 0 : (activity.title === '新年活动（⚠️估算）' ? 550 : 350) }}
                                        </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="activityReviewCompleted[activity.title]"
                                                @change="toggleActivityReviewCompletion(activity.title)">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本期已完成</span>
                                    </div>
                                </div>
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">角色试用：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶"> 
                                            {{ activityTrialCompleted[activity.title] ? 0 : (activity.title === '主线版本（⚠️估算）' || activity.title === '新年活动（⚠️估算）' ? 70 : 40) }}
                                        </span>
                                    </div>
                                    <div class="switch-group small">
                                        <label class="switch">
                                            <input type="checkbox" v-model="activityTrialCompleted[activity.title]"
                                                @change="toggleActivityTrialCompletion(activity.title)">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label">本期已完成</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 氪金资源模块 -->
                    <div class="potential-section card">
                        <h2 @click="toggleSection('recharge')" class="section-header">
                            💰 氪金资源
                            <span class="collapse-icon">{{ sections.recharge ? '−' : '+' }}</span>
                        </h2>
                        <div v-if="sections.recharge" class="section-content">
                            <!-- 月卡购买控制 -->
                            <div class="sub-section">
                                <h3 class="sub-title">黑钥贵宾（小月卡）</h3>
                                
                                <div class="resource-input-vertical" style="margin-bottom: 15px;">
                                    <label style="min-width: 200px; display: flex; align-items: center; gap: 5px;">
                                        额外购买
                                        <button class="skin-btn" @click="adjustMonthlyCard(-1)">−</button>
                                        <span class="skin-count" style="min-width: 40px; text-align: center;">{{ monthlyCardCount }}</span>
                                        <button class="skin-btn" @click="adjustMonthlyCard(1)">+</button>
                                        张月卡(负数代表已提前购买)：
                                    </label>
                                </div>
                                
                                <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                    额外购买一张月卡可提前拿到300璀璨晶源，已提前购买则只能拿到每日60异方晶，不计算30RMB
                                </div>
                                
                                <!-- 月卡奖励按钮 -->
                                <button 
                                    class="training-btn" 
                                    :class="{ active: monthlyCardActive }"
                                    @click="toggleMonthlyCard"
                                    style="width: calc(100% - 30px); margin: 0 auto 15px; display: block;">
                                    黑钥贵宾 
                                    <img :src="premiumCrystalIcon" class="resource-icon" alt="璀璨晶源"> {{ monthlyCardPremiumCrystal }} 
                                    <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ monthlyCardCrystal }}
                                </button>
                            </div>

                            <!-- 高级监察密令模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title">高级监察密令（大月卡）</h3>
                                
                                <div class="resource-input-vertical" style="margin-bottom: 15px;">
                                    <label style="min-width: 200px; display: flex; align-items: center; gap: 5px;">
                                        额外购买
                                        <button class="skin-btn" @click="adjustInspectionOrder(-1)">−</button>
                                        <span class="skin-count" style="min-width: 40px; text-align: center;">{{ inspectionOrderCount }}</span>
                                        <button class="skin-btn" @click="adjustInspectionOrder(1)">+</button>
                                        期高级监察密令(负数代表已提前购买)：
                                    </label>
                                </div>
                                
                                <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                    额外购买的高级监察密令默认可拿到当期奖励，已提前购买则不计算68RMB
                                </div>
                                
                                <!-- 高级监察密令奖励按钮 -->
                                <button 
                                    class="training-btn" 
                                    :class="{ active: inspectionOrderActive }"
                                    @click="toggleInspectionOrder"
                                    style="width: calc(100% - 30px); margin: 0 auto 15px; display: block;">
                                    高级监察密令 
                                    <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ inspectionOrderCrystalAmount }} 
                                    <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ inspectionOrderTicketAmount }}
                                </button>
                            </div>

                            <!-- 狄斯盈满钵模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>狄斯盈满钵</span>
                                    <div class="switch-group" style="margin: 0;">
                                        <span class="switch-label" :class="{ active: !disiPrePurchased, inactive: disiPrePurchased }">未预先购买</span>
                                        <label class="switch">
                                            <input type="checkbox" v-model="disiPrePurchased" :disabled="!disiActive">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label" :class="{ active: disiPrePurchased, inactive: !disiPrePurchased }">已预先购买</span>
                                    </div>
                                </h3>
                                
                                <button 
                                    class="training-btn" 
                                    :class="{ active: disiActive }"
                                    @click="toggleDisi"
                                    style="width: calc(100% - 30px); margin: 0 auto 15px; display: block;">
                                    狄斯盈满钵
                                    <img :src="premiumCrystalIcon" class="resource-icon" alt="璀璨晶源"> {{ disiPremiumCrystal }} 
                                    <img :src="crystalIcon" class="resource-icon" alt="异方晶"> {{ disiRewardTotal }}
                                </button>
                                
                                <div class="slider-container">
                                    <div class="slider-labels">
                                        <span>0级</span>
                                        <span>50级</span>
                                    </div>
                                    <input 
                                        type="range" 
                                        v-model.number="disiLevel" 
                                        min="0" 
                                        max="50"
                                        step="1"
                                        class="inspection-slider"
                                        list="disi-levels"
                                        @input="snapDisiLevel"
                                        :disabled="!disiActive"
                                    >
                                    <datalist id="disi-levels">
                                        <option value="0">0</option>
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                        <option value="25">25</option>
                                        <option value="30">30</option>
                                        <option value="35">35</option>
                                        <option value="40">40</option>
                                        <option value="42">42</option>
                                        <option value="44">44</option>
                                        <option value="46">46</option>
                                        <option value="48">48</option>
                                        <option value="50">50</option>
                                    </datalist>
                                    <div class="slider-value">
                                        当前等级: {{ disiLevel }}
                                    </div>
                                </div>
                            </div>

                            <!-- 诡珑珍宝馆模块 -->
                            <div class="sub-section">
                                <h3 class="sub-title" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>诡珑珍宝馆</span>
                                    <div class="switch-group" style="margin: 0;">
                                        <span class="switch-label" :class="{ active: !treasurePrePurchased, inactive: treasurePrePurchased }">未预先购买</span>
                                        <label class="switch">
                                            <input type="checkbox" v-model="treasurePrePurchased" :disabled="!treasureActive">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="switch-label" :class="{ active: treasurePrePurchased, inactive: !treasurePrePurchased }">已预先购买</span>
                                    </div>
                                </h3>
                                
                                <button 
                                    class="training-btn" 
                                    :class="{ active: treasureActive }"
                                    @click="toggleTreasure"
                                    style="width: calc(100% - 30px); margin: 0 auto 15px; display: block;">
                                    诡珑珍宝馆 
                                    <img :src="ticketIcon" class="resource-icon" alt="搜索令"> {{ treasureTickets }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- 其他（⚠️估算）模块 -->
                    <div class="potential-section card">
                        <h2 @click="toggleSection('otherEstimate')" class="section-header">
                            📝 其他资源（⚠️估算）
                            <span class="collapse-icon">{{ sections.otherEstimate ? '−' : '+' }}</span>
                        </h2>
                        <div v-if="sections.otherEstimate" class="section-content">
                            <!-- 前瞻兑换码子模块 -->
                            <div class="sub-section">
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">前瞻兑换码：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">
                                            {{ previewCodeCrystal }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- 签到奖励子模块 -->
                            <div class="sub-section">
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">{{ signInRewardTitle }}：</span>
                                        <span class="item-value">
                                            <img :src="signInRewardIcon" class="resource-icon" alt="奖励">
                                            {{ signInRewardDisplayAmount }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- 停服更新子模块 -->
                            <div class="sub-section">
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">停服更新：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">
                                            {{ maintenanceCrystal }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- 停服维护子模块 -->
                            <div class="sub-section">
                                <div class="accumulation-item">
                                    <div class="item-info">
                                        <span class="item-title">停服维护：</span>
                                        <span class="item-value">
                                            <img :src="crystalIcon" class="resource-icon" alt="异方晶">
                                            {{ maintenanceRepairCrystal }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        const app = createApp({
            name: 'GachaCalculator',
            data() {

                let savedData = {};
                try {
                    const saved = localStorage.getItem('gachaCalculatorData');
                    if (saved) {
                        savedData = JSON.parse(saved);
                        // 验证数据完整性
                        if (typeof savedData !== 'object') {
                            throw new Error('Invalid data format');
                        }
                    }
                } catch (e) {
                    console.error('解析localStorage失败，清除损坏数据并使用默认数据', e);
                    localStorage.removeItem('gachaCalculatorData'); // 清除损坏数据
                    savedData = {};
                }                
                return {

                    // 饼状图悬停状态
                    hoveredPieModule: null,
                    hoveredPieIndex: -1, // 新增：记录悬停的模块索引

                    // 饼状图数据
                    pieChartColors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'],
                    pieChartData: [],

                    // 新增：活动排期数据
                    activitySchedule: [
                        { start: '2025-10-23', end: '2025-11-20', title: '妄夜迷章' },
                        { start: '2025-11-20', end: '2025-12-18', title: '主线版本（⚠️估算）' },
                        { start: '2025-12-18', end: '2026-01-15', title: '1218-0115活动（⚠️估算）' },
                        { start: '2026-01-15', end: '2026-02-12', title: '0115-0212活动（⚠️估算）' },
                        { start: '2026-02-12', end: '2026-03-12', title: '新年活动（⚠️估算）' }
                    ],
                    
                    // 新增：活动完成状态
                    activityCompleted: savedData?.activityCompleted || {},
                    // 新增：活动审查奖励完成状态
                    activityReviewCompleted: savedData?.activityReviewCompleted || {},
                    // 新增：活动角色试用奖励完成状态
                    activityTrialCompleted: savedData?.activityTrialCompleted || {},
                    // 新增：活动复刻模式状态
                    activityRerunMode: savedData?.activityRerunMode || {},

                    // 新增：卡池日期 - 改为响应式数据
                    poolDates: {
                        nextVersion: new Date(2025, 10, 20),  // 2025年11月20日
                        newYear: new Date(2026, 1, 12)        // 2026年2月12日
                    },
    

                    // 图标路径 - 使用绝对路径
                    crystalIcon: 'icons/crystal.png',
                    ticketIcon: 'icons/ticket.png',
                    redCrystalIcon: 'icons/red_crystal.png',
                    premiumCrystalIcon: 'icons/premium_crystal.png',
                    yellowTicketIcon: 'icons/yellow_ticket.png',
                    hlIcon:'icons/hl.gif',
                    limitedCouponIcon: 'icons/Limitedcoupon.png',

                    actionSummaryLevel: savedData?.actionSummaryLevel || 0,
                    actionSummaryList: [
                        "01·混沌彼岸",
                        "02·混沌彼岸", 
                        "03·无主地窟",
                        "04·无主地窟",
                        "05·奇兰广场",
                        "06·奇兰广场",
                        "07·嘉年华",
                        "08·嘉年华",
                        "09·流民寨",
                        "10·流民寨",
                        "11·沉浊暗阱",
                        "12·沉浊暗阱",
                        "13·高塔黑环",
                        "N1·暗涌",
                        "N2·暗涌", 
                        "N3·碎金盛宴",
                        "N4·碎金盛宴",
                        "N5·残锋",
                        "N6·残锋"
                    ],

                    // 原有数据保持不变
                    resources: savedData?.resources || {
                        crystal: 0,
                        premiumCrystal: 0,
                        tickets: 0
                    },
                    selectedTime: savedData?.selectedTime || 'nextVersion',
                    calculateToPoolEnd: savedData?.calculateToPoolEnd || false,
                    weeklyCompleted: savedData?.weeklyCompleted || false,
                    darkZoneSweepOnly: savedData?.darkZoneSweepOnly || false,
                    darkZoneCompleted: savedData?.darkZoneCompleted || false,
                    darkZoneFirstCompleted: savedData?.darkZoneFirstCompleted || false,
                    trackingExchanged: savedData?.trackingExchanged || false,
                    friendshipExchanged: savedData?.friendshipExchanged || false,
                    usePremiumCrystal: savedData?.usePremiumCrystal || false,
                    skinReserve: savedData?.skinReserve || {
                        skin880: 0,
                        skin1280: 0,
                        skin2580: 0
                    },
                    customAdjustment: savedData?.customAdjustment || 0,
                    sections: savedData?.sections || {
                        resources: false,
                        daily: false,
                        potential: false,
                        activities: false,
                        pullSummary: false,
                        recharge: false,
                        otherEstimate: false
                    },
                    versionWeeks: 4,
                    monthlyCardCount: savedData?.monthlyCardCount || 0,
                    monthlyCardActive: savedData?.monthlyCardActive || false,
                    inspectionOrderActive: savedData?.inspectionOrderActive || false,
                    inspectionOrderCount: savedData?.inspectionOrderCount || 0,
                    dailyInspectionOrderLevel: savedData?.dailyInspectionOrderLevel || 0,
                    
                    emotionDetectionCompleted: savedData?.emotionDetectionCompleted || false,
                    signInRewardCompleted: savedData?.signInRewardCompleted || false,
                    dailyShareCompleted: savedData?.dailyShareCompleted || false,
                    trackingCertificationCount: savedData?.trackingCertificationCount || 0,
                    useTrackingCertification: savedData?.useTrackingCertification || false,
                    trainingModes: savedData?.trainingModes || {
                        steady: false,
                        fluctuating: false,
                        outOfControl: false,
                        crazy: false
                    },
                    
                    nightmareScore: savedData?.nightmareScore || 0,
                    nightmareSeaCompleted: savedData?.nightmareSeaCompleted || false,
                    nightMazeCompleted: savedData?.nightMazeCompleted || false,
                    
                    dataGap: savedData?.dataGap || {
                        targets: {
                            missionComplete: false,
                            missionCount: false,
                            targetComplete: false
                        },
                        ratings: {
                            healing: false,
                            shield: false,
                            controlTime: false,
                            controlCount: false,
                            totalDamage: false,
                            coreDamage: false,
                            comprehensive: false
                        }
                    },

                    // 新增模块数据
                    mainStory: savedData?.mainStory || {
                        chaosBeyondA: false,
                        chaosBeyondB: false,
                        unownedCavernA: false,
                        unownedCavernB: false,
                        kiranSquareA: false,
                        kiranSquareB: false,
                        carnivalA: false,
                        carnivalB: false,
                        refugeeCampA: false,
                        refugeeCampB: false,
                        muddyDarkTrapA: false,
                        muddyDarkTrapB: false,
                        highTowerBlackRing: false,
                        darkSurgeA: false,
                        darkSurgeB: false,
                        goldFeastA: false,
                        goldFeastB: false
                    },

                    // 狄斯暗影（EX）数据
                    darkShadowEx: savedData?.darkShadowEx || {
                        chaosBeyond: false,
                        unownedCavern: false,
                        kiranSquare: false,
                        carnival: false,
                        highTowerBlackRing: false,
                        luxuryFeastFog: false,
                        drowningRainCity: false,
                        goldFeast: false
                    },

                    memoryStorm: savedData?.memoryStorm || {
                        memoryAnomaly: false,
                        impressionAnomaly: false,
                        echoAnomaly: false
                    },

                    pollutionNest: savedData?.pollutionNest || {
                        forbiddenZoneProbe: false,
                        extremeDomainSearch: false
                    },

                    cleanupOperation: savedData?.cleanupOperation || {
                        goldRush: false,
                        ominousSeed: false
                    },

                    palmaRuins: savedData?.palmaRuins || {
                        tenacious: false,
                        berserk: false,
                        mysterious: false,
                        precise: false,
                        supernatural: false,
                        inspiration: false
                    },
                    
                    // 新增角色养成模块数据
                    characterDevelopment: savedData?.characterDevelopment || {
                        tier3: 0,
                        maxReverbS: 0,
                        maxReverbA: 0,
                        maxReverbB: 0,
                        reviewS: 0,
                        reviewA: 0,
                        haylaReviewed: false
                    },
                    
                    nightmareRewards: [
                        { score: 1000, crystal: 100, tickets: 0 },
                        { score: 1500, crystal: 120, tickets: 0 },
                        { score: 2000, crystal: 0, tickets: 1 },
                        { score: 3000, crystal: 150, tickets: 0 },
                        { score: 4000, crystal: 0, tickets: 1 },
                        { score: 5000, crystal: 150, tickets: 0 },
                        { score: 6000, crystal: 200, tickets: 0 },
                        { score: 7000, crystal: 200, tickets: 0 },
                        { score: 8000, crystal: 0, tickets: 1 },
                        { score: 10000, crystal: 100, tickets: 0 },
                        { score: 12000, crystal: 100, tickets: 0 },
                        { score: 14000, crystal: 100, tickets: 0 },
                        { score: 16000, crystal: 100, tickets: 0 },
                        { score: 18000, crystal: 100, tickets: 0 },
                        { score: 20000, crystal: 100, tickets: 0 },
                        { score: 22000, crystal: 100, tickets: 0 },
                        { score: 24000, crystal: 0, tickets: 1 },
                        { score: 26000, crystal: 100, tickets: 0 },
                        { score: 28000, crystal: 100, tickets: 0 },
                        { score: 30000, crystal: 100, tickets: 0 },
                        { score: 32000, crystal: 100, tickets: 0 },
                        { score: 34000, crystal: 100, tickets: 0 },
                        { score: 36000, crystal: 0, tickets: 1 },
                        { score: 38000, crystal: 100, tickets: 0 },
                        { score: 40000, crystal: 100, tickets: 0 },
                        { score: 42000, crystal: 100, tickets: 0 },
                        { score: 44000, crystal: 100, tickets: 0 },
                        { score: 46000, crystal: 100, tickets: 0 },
                        { score: 48000, crystal: 0, tickets: 1 },
                        { score: 50000, crystal: 100, tickets: 0 },
                        { score: 52000, crystal: 100, tickets: 0 },
                        { score: 54000, crystal: 100, tickets: 0 },
                        { score: 56000, crystal: 100, tickets: 0 },
                        { score: 58000, crystal: 100, tickets: 0 },
                        { score: 60000, crystal: 0, tickets: 1 }
                    ],
                    // 狄斯盈满钵数据
                    disiLevel: savedData?.disiLevel || 0,
                    disiActive: savedData?.disiActive || false,
                    disiPrePurchased: savedData?.disiPrePurchased || false,
                    // 诡珑珍宝馆数据
                    treasureActive: savedData?.treasureActive || false,
                    treasurePrePurchased: savedData?.treasurePrePurchased || false,
                    disiRewards: [
                        { level: 0, crystal: 0 },
                        { level: 5, crystal: 400 },
                        { level: 10, crystal: 400 },
                        { level: 15, crystal: 500 },
                        { level: 20, crystal: 500 },
                        { level: 25, crystal: 600 },
                        { level: 30, crystal: 600 },
                        { level: 35, crystal: 600 },
                        { level: 40, crystal: 800 },
                        { level: 42, crystal: 800 },
                        { level: 44, crystal: 800 },
                        { level: 46, crystal: 1000 },
                        { level: 48, crystal: 1000 },
                        { level: 50, crystal: 1800 }
                    ]
                }
            },
            computed: {

                // 计算大于滑块等级的所有异方晶奖励总和
                nightmareRemainingCrystal() {
                    let totalCrystal = 0;
                    
                    for (const reward of this.nightmareRewards) {
                        // 只计算大于当前滑块等级的奖励
                        if (this.nightmareScore < reward.score) {
                            totalCrystal += reward.crystal;
                        }
                    }
                    
                    return totalCrystal;
                },

                // 签到奖励显示数量
                signInRewardDisplayAmount() {
                    if (this.selectedTime === 'nextVersion') {
                        // 主线版本：显示搜索令数量
                        return this.calculateToPoolEnd ? 14 : 3;
                    } else {
                        // 新年版本：显示限定券数量
                        return this.calculateToPoolEnd ? 24 : 11;
                    }
                },

                // 计算各模块抽数
                totalModulePulls() {
                    return this.pieChartData.reduce((total, module) => total + module.pulls, 0);
                },

                // 分模块抽数数据 - 精确计算，确保与顶部总计一致
                modulePullsData() {
                    // 使用与 totalPulls 完全相同的计算逻辑
                    const totalCrystal = this.totalCrystalSummary;
                    const totalPremiumCrystal = this.totalPremiumCrystalSummary;
                    const totalTickets = this.totalTicketsSummary;
                    const totalLimitedCoupons = this.totalLimitedCouponsSummary;
                    
                    // 顶部总计的计算方式
                    const headerCrystalPulls = Math.floor(totalCrystal / 180);
                    const headerPremiumCrystalPulls = Math.floor(totalPremiumCrystal / 180);
                    const headerTicketPulls = totalTickets;
                    const headerLimitedCouponPulls = totalLimitedCoupons;
                    const headerTotal = headerCrystalPulls + headerPremiumCrystalPulls + headerTicketPulls + headerLimitedCouponPulls;
                    
                    console.log('=== 顶部总计分解 ===');
                    console.log('- 异方晶抽数:', headerCrystalPulls, '(异方晶:', totalCrystal, ')');
                    console.log('- 璀璨晶源抽数:', headerPremiumCrystalPulls, '(璀璨晶源:', totalPremiumCrystal, ')');
                    console.log('- 搜索令抽数:', headerTicketPulls);
                    console.log('- 限定券抽数:', headerLimitedCouponPulls);
                    console.log('- 顶部总计:', headerTotal);
                    
                    // 现在精确分解到各模块
                    // 1. 当前资源模块
                    const baseCrystal = this.resources.crystal || 0;
                    const basePremiumCrystal = this.usePremiumCrystal ? (this.resources.premiumCrystal || 0) : 0;
                    const baseTickets = this.resources.tickets || 0;
                    
                    const currentCrystalPulls = Math.floor(Math.max(0, baseCrystal - this.totalSkinReserve + this.customAdjustment) / 180);
                    const currentPremiumCrystalPulls = Math.floor(basePremiumCrystal / 180);
                    const currentTicketPulls = baseTickets;
                    const currentPulls = currentCrystalPulls + currentPremiumCrystalPulls + currentTicketPulls;
                    
                    console.log('=== 当前资源模块 ===');
                    console.log('- 基础异方晶:', baseCrystal);
                    console.log('- 皮肤预留:', this.totalSkinReserve);
                    console.log('- 自定义修正:', this.customAdjustment);
                    console.log('- 可用异方晶:', Math.max(0, baseCrystal - this.totalSkinReserve + this.customAdjustment));
                    console.log('- 异方晶抽数:', currentCrystalPulls);
                    console.log('- 璀璨晶源抽数:', currentPremiumCrystalPulls);
                    console.log('- 搜索令抽数:', currentTicketPulls);
                    console.log('- 当前模块总计:', currentPulls);
                    
                    // 2. 日常积累模块
                    const dailyCrystal = this.dailyAccumulationCrystal;
                    const dailyTickets = this.dailyAccumulationTickets;
                    const dailyPulls = Math.floor(dailyCrystal / 180) + dailyTickets;
                    
                    console.log('=== 日常积累模块 ===');
                    console.log('- 日常异方晶:', dailyCrystal);
                    console.log('- 日常搜索令:', dailyTickets);
                    console.log('- 日常模块总计:', dailyPulls);
                    
                    // 3. 活动奖励模块
                    const activityCrystal = this.activityRewardsCrystal;
                    const activityTickets = this.activityRewardsTickets;
                    const activityPulls = Math.floor(activityCrystal / 180) + activityTickets;
                    
                    console.log('=== 活动奖励模块 ===');
                    console.log('- 活动异方晶:', activityCrystal);
                    console.log('- 活动搜索令:', activityTickets);
                    console.log('- 活动模块总计:', activityPulls);
                    
                    // 4. 潜在资源模块
                    const potentialCrystal = this.otherSystemsCrystal;
                    const potentialTickets = this.otherSystemsTickets;
                    const potentialPulls = Math.floor(potentialCrystal / 180) + potentialTickets;
                    
                    console.log('=== 潜在资源模块 ===');
                    console.log('- 潜在异方晶:', potentialCrystal);
                    console.log('- 潜在搜索令:', potentialTickets);
                    console.log('- 潜在模块总计:', potentialPulls);
                    
                    // 5. 氪金资源模块
                    const rechargePremiumCrystal = this.monthlyCardPremiumCrystal + this.disiPremiumCrystal;
                    const rechargePremiumCrystalPulls = Math.floor(rechargePremiumCrystal / 180);
                    const rechargeCrystal = this.monthlyCardCrystal + this.rechargeInspectionOrderCrystal + (this.disiActive ? this.disiRewardTotal : 0);
                    const rechargeCrystalPulls = Math.floor(rechargeCrystal / 180);
                    const rechargeTicketPulls = this.rechargeInspectionOrderTickets + this.treasureTickets;
                    const rechargePulls = rechargeCrystalPulls + rechargePremiumCrystalPulls + rechargeTicketPulls;
                    
                    console.log('=== 氪金资源模块 ===');
                    console.log('- 氪金璀璨晶源:', rechargePremiumCrystal);
                    console.log('- 氪金璀璨晶源抽数:', rechargePremiumCrystalPulls);
                    console.log('- 氪金异方晶:', rechargeCrystal);
                    console.log('- 氪金异方晶抽数:', rechargeCrystalPulls);
                    console.log('- 氪金搜索令:', rechargeTicketPulls);
                    console.log('- 氪金模块总计:', rechargePulls);
                    
                    // 6. 其他估算模块
                    const otherCrystal = this.previewCodeCrystal + this.maintenanceCrystal + this.maintenanceRepairCrystal;
                    const otherTickets = this.signInRewardTickets;
                    const otherLimitedCoupons = this.signInRewardLimitedCoupons;
                    const otherPulls = Math.floor(otherCrystal / 180) + otherTickets + otherLimitedCoupons;
                    
                    console.log('=== 其他估算模块 ===');
                    console.log('- 其他异方晶:', otherCrystal);
                    console.log('- 其他搜索令:', otherTickets);
                    console.log('- 其他限定券:', otherLimitedCoupons);
                    console.log('- 其他模块总计:', otherPulls);
                    
                    // 计算饼状图总计
                    const pieTotal = currentPulls + dailyPulls + activityPulls + potentialPulls + rechargePulls + otherPulls;
                    
                    console.log('=== 最终对比 ===');
                    console.log('- 饼状图总计:', pieTotal);
                    console.log('- 顶部总计:', headerTotal);
                    console.log('- 差异:', headerTotal - pieTotal);
                    
                    // 如果存在差异，找出问题所在
                    if (pieTotal !== headerTotal) {
                        console.error('❌ 数据不一致！需要检查计算逻辑');
                        // 这里不强制对齐，而是让问题暴露出来便于调试
                    }
                    
                    return [
                        { name: '现有', pulls: currentPulls, color: this.pieChartColors[0] },
                        { name: '日常', pulls: dailyPulls, color: this.pieChartColors[1] },
                        { name: '活动', pulls: activityPulls, color: this.pieChartColors[2] },
                        { name: '潜在', pulls: potentialPulls, color: this.pieChartColors[3] },
                        { name: '氪金', pulls: rechargePulls, color: this.pieChartColors[4] },
                        { name: '其他', pulls: otherPulls, color: this.pieChartColors[5] }
                    ];
                },
                // 前瞻兑换码异方晶
                previewCodeCrystal() {
                    if (this.selectedTime === 'nextVersion') {
                        // 主线版本：600异方晶
                        return 600;
                    } else {
                        // 新年版本：1200异方晶
                        return 1200;
                    }
                },

                // 停服更新异方晶
                maintenanceCrystal() {
                    if (this.selectedTime === 'nextVersion') {
                        // 主线版本：1个版本 * 300
                        return 1 * 300;
                    } else {
                        // 新年版本：2个版本 * 200 + 2个版本 * 300 = 1000
                        return (2 * 200) + (2 * 300);
                    }
                },

                // 停服维护异方晶
                maintenanceRepairCrystal() {
                    if (this.selectedTime === 'nextVersion') {
                        // 主线版本
                        if (!this.calculateToPoolEnd) {
                            // 计算到卡池开放当天时，版本刚开不维护，显示0
                            return 0;
                        } else {
                            // 计算到卡池结束当天时，版本中期维护过了，显示200
                            return 200;
                        }
                    } else {
                        // 新年版本
                        if (!this.calculateToPoolEnd) {
                            // 计算到卡池开放当天时，版本刚开不维护，显示600
                            return 600;
                        } else {
                            // 计算到卡池结束当天时，版本中期维护过了，显示800
                            return 800;
                        }
                    }
                },

                // 签到奖励标题
                signInRewardTitle() {
                    if (this.selectedTime === 'nextVersion') {
                        return '签到奖励';
                    } else {
                        return '签到奖励';
                    }
                },

                // 签到奖励图标
                signInRewardIcon() {
                    if (this.selectedTime === 'nextVersion') {
                        return this.ticketIcon;
                    } else {
                        return this.limitedCouponIcon;
                    }
                },

                // 签到奖励数量（搜索令）
                signInRewardTickets() {
                    if (this.selectedTime === 'nextVersion') {
                        // 主线版本：签到给搜索令
                        return this.calculateToPoolEnd ? 14 : 3;
                    } else {
                        // 新年版本：签到给限定券，搜索令为0
                        return 0;
                    }
                },

                // 签到奖励数量（限定券）
                signInRewardLimitedCoupons() {
                    if (this.selectedTime === 'nextVersion') {
                        // 主线版本：没有限定券
                        return 0;
                    } else {
                        // 新年版本：签到给限定券
                        return this.calculateToPoolEnd ? 24 : 11;
                    }
                },

                // 限定券总计
                totalLimitedCouponsSummary() {
                    return this.signInRewardLimitedCoupons; // 直接使用签到奖励的限定券数量
                },

                // 总计抽数 - 汇总所有抽卡资源
                totalPulls() {
                    // 异方晶抽数
                    const crystalPulls = Math.floor(this.totalCrystalSummary / 180);
                    
                    // 璀璨晶源抽数（包含狄斯盈满钵）
                    const premiumCrystalPulls = Math.floor(this.totalPremiumCrystalSummary / 180);
                    
                    // 搜索令抽数
                    const ticketPulls = this.totalTicketsSummary;
                    
                    // 限定券抽数
                    const limitedCouponPulls = this.totalLimitedCouponsSummary;
                    
                    // 总计抽数
                    const totalPulls = crystalPulls + premiumCrystalPulls + ticketPulls + limitedCouponPulls;
                    
                    return totalPulls;
                },

                // 新增：计算需要显示的活动模块
                displayActivities() {
                    const activities = [];
                    const today = new Date();
                    
                    // 根据选定的卡池时间确定目标日期 - 使用 poolDates 中的数据
                    let targetDate;
                    if (this.selectedTime === 'nextVersion') {
                        targetDate = this.calculateToPoolEnd ? 
                            new Date(this.poolDates.nextVersion.getTime() + (this.versionWeeks * 7 * 24 * 60 * 60 * 1000)) :
                            this.poolDates.nextVersion;
                    } else {
                        targetDate = this.calculateToPoolEnd ? 
                            new Date(this.poolDates.newYear.getTime() + (this.versionWeeks * 7 * 24 * 60 * 60 * 1000)) :
                            this.poolDates.newYear;
                    }
                    
                    // 遍历活动排期，只显示在当前日期和目标日期之间的活动
                    for (let i = 0; i < this.activitySchedule.length; i++) {
                        const activity = this.activitySchedule[i];
                        const activityStartDate = new Date(activity.start);
                        const activityEndDate = new Date(activity.end);
                        
                        // 显示条件：活动在当前日期之后开始，且在目标日期之前结束
                        // 或者活动正在进行中（今天在活动期间内）
                        if (activityEndDate > today && activityStartDate <= targetDate) {
                            activities.push(activity);
                        }
                    }
                    
                    return activities;
                },

                // 格式化日期
                formattedNewYearDate() {
                    const date = this.poolDates.newYear;
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                },

                formattedNextVersionDate() {
                    const date = this.poolDates.nextVersion;
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                },

                // 日常积累模块的搜索令计算
                dailyInspectionOrderTickets() {
                    let tickets = 0;
                    const levels = [5, 15, 25, 35, 45, 55];
                    
                    for (const level of levels) {
                        if (this.dailyInspectionOrderLevel < level) {
                            tickets += 1;
                        }
                    }
                    
                    const periods = this.calculateInspectionPeriods;
                    const totalPerPeriod = 6;
                    
                    return tickets + (periods - 1) * totalPerPeriod;
                },

                // 新增行动纪要异方晶计算
                actionSummaryCrystal() {
                    // 总异方晶3800，滑块从0到18，每滑动一格减少200
                    const totalCrystal = 3800;
                    const crystalPerStep = 200;
                    return totalCrystal - (this.actionSummaryLevel * crystalPerStep);
                },

                daysToNextVersion() {
                    const today = new Date();
                    const targetDate = this.poolDates.nextVersion;
                    const diffTime = targetDate - today;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                },
                
                daysToNewYear() {
                    const today = new Date();
                    const targetDate = this.poolDates.newYear;
                    const diffTime = targetDate - today;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                },
                
                selectedDays() {
                    const baseDays = this.selectedTime === 'nextVersion' 
                        ? this.daysToNextVersion 
                        : this.daysToNewYear;
                    return this.calculateToPoolEnd ? baseDays + (this.versionWeeks * 7) : baseDays;
                },
                
                weeklyCount() {
                    const today = new Date();
                    let targetDate = this.selectedTime === 'nextVersion' 
                        ? this.poolDates.nextVersion 
                        : this.poolDates.newYear;
                    
                    // 如果计算到卡池结束，则加上版本周数
                    if (this.calculateToPoolEnd) {
                        targetDate = new Date(targetDate.getTime() + (this.versionWeeks * 7 * 24 * 60 * 60 * 1000));
                    }
                    
                    // 计算从当前周一到目标日期之间的完整周数
                    const currentMonday = new Date(today);
                    const dayOfWeek = today.getDay(); // 0是周日，1是周一，...6是周六
                    const daysToMonday = dayOfWeek === 0 ? 1 : (dayOfWeek === 1 ? 0 : 8 - dayOfWeek);
                    currentMonday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    
                    // 计算周数（包含当前周）
                    const diffTime = targetDate - currentMonday;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const diffWeeks = Math.ceil(diffDays / 7);
                    
                    return Math.max(1, diffWeeks); // 至少1周
                },

                remainingWeeklyCount() {
                    // 如果本周已完成，则从下周开始计算
                    if (this.weeklyCompleted) {
                        return Math.max(0, this.weeklyCount - 1);
                    } else {
                        return this.weeklyCount;
                    }
                },

                remainingShareWeeks() {
                    // 分享周数计算逻辑与周常相同
                    if (this.dailyShareCompleted) {
                        return Math.max(0, this.weeklyCount - 1);
                    } else {
                        return this.weeklyCount;
                    }
                },

                remainingShareTotal() {
                    return 60 * this.remainingShareWeeks;
                },

                remainingDarkZoneWeeks() {
                    // 暗域周数计算逻辑与周常相同
                    if (this.darkZoneCompleted) {
                        return Math.max(0, this.weeklyCount - 1);
                    } else {
                        return this.weeklyCount;
                    }
                },
                
                darkZonePerWeek() {
                    return this.darkZoneSweepOnly ? 450 : 510;
                },
                
                dailyActiveTotal() {
                    return 40 * this.selectedDays;
                },
                
                remainingWeeklyTotal() {
                    return 150 * this.remainingWeeklyCount;
                },
                
                remainingDarkZoneTotal() {
                    return this.darkZonePerWeek * this.remainingDarkZoneWeeks;
                },
                
                remainingTrackingExchange() {
                    return this.trackingExchanged ? 0 : 5;
                },
                
                remainingFriendshipExchange() {
                    return this.friendshipExchanged ? 0 : 3;
                },
                
                trackingCertificationTickets() {
                    return this.useTrackingCertification ? Math.floor(this.trackingCertificationCount / 8) : 0;
                },
                
                nightmareCrystalReward() {
                    return this.calculateNightmareRewards().crystal;
                },

                nightmareTicketReward() {
                    return this.calculateNightmareRewards().tickets;
                },
                
                nightmareSeaReward() {
                    return this.nightmareSeaCompleted ? 0 : 930;
                },
                
                totalWeeklyActive() {
                    // 使用剩余周数计算逻辑
                    return 150 * this.remainingWeeklyCount;
                },
                
                totalDarkZone() {
                    // 使用剩余暗域周数计算逻辑
                    return this.darkZonePerWeek * this.remainingDarkZoneWeeks;
                },
                
                totalDarkZoneFirst() {
                    return this.darkZoneFirstCompleted ? 0 : 450;
                },
                
                // 计算从现在到目标日期之间的月份数
                remainingMonths() {
                    const today = new Date();
                    let targetDate = this.selectedTime === 'nextVersion' 
                        ? this.poolDates.nextVersion
                        : this.poolDates.newYear;
                    
                    // 如果计算到卡池结束，则加上版本周数
                    if (this.calculateToPoolEnd) {
                        targetDate = new Date(targetDate.getTime() + (this.versionWeeks * 7 * 24 * 60 * 60 * 1000));
                    }
                    
                    // 正确的计算方法：计算跨越的月份数（包含起始月和结束月）
                    let months = (targetDate.getFullYear() - today.getFullYear()) * 12;
                    months += targetDate.getMonth() - today.getMonth();
                    
                    // 如果目标日期的日期大于等于今天的日期，则加1个月（包含当前月）
                    if (targetDate.getDate() >= today.getDate()) {
                        months++;
                    } else {
                        // 如果目标日期的日期小于今天的日期，但还在同一个月内，也要包含当前月
                        months++;
                    }
                    
                    // 确保至少为1个月
                    return Math.max(1, months);
                },

                totalEmotionDetection() {
                    // 开关打开（已完成本月）：显示剩余月份-1的奖励
                    // 开关关闭（未完成本月）：显示总月份数的奖励
                    const monthlyReward = 50;
                    if (this.emotionDetectionCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },

                totalEmotionDetectionTickets() {
                    const monthlyReward = 1;
                    if (this.emotionDetectionCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },

                totalSignInReward() {
                    const monthlyReward = 100;
                    if (this.signInRewardCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },

                totalSignInRewardTickets() {
                    const monthlyReward = 1;
                    if (this.signInRewardCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },

                // 新增：用于总计计算的奖励（不考虑显示，只考虑实际可获得奖励）
                totalEmotionDetectionForSummary() {
                    const monthlyReward = 50;
                    if (this.emotionDetectionCompleted) {
                        // 已完成本月，只能获得剩余月份的奖励
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        // 未完成本月，可以获得全部月份的奖励
                        return this.remainingMonths * monthlyReward;
                    }
                },
                
                totalEmotionDetectionTicketsForSummary() {
                    const monthlyReward = 1;
                    if (this.emotionDetectionCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },

                totalSignInRewardForSummary() {
                    const monthlyReward = 100;
                    if (this.signInRewardCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },
                
                totalSignInRewardTicketsForSummary() {
                    const monthlyReward = 1;
                    if (this.signInRewardCompleted) {
                        return Math.max(0, (this.remainingMonths - 1)) * monthlyReward;
                    } else {
                        return this.remainingMonths * monthlyReward;
                    }
                },

                totalDailyShare() {
                    // 使用剩余分享周数计算逻辑
                    return 60 * this.remainingShareWeeks;
                },
                
                totalTrackingExchange() {
                    return this.trackingExchanged ? 0 : 5;
                },
                
                totalFriendshipExchange() {
                    return this.friendshipExchanged ? 0 : 3;
                },
                
                totalTrackingCertification() {
                    return 0; // 黄票兑换不产生异方晶，只产生搜索令
                },
                
                totalTrackingCertificationTickets() {
                    return this.useTrackingCertification ? Math.floor(this.trackingCertificationCount / 8) : 0;
                },
                
                trainingRewards() {
                    let crystal = 0;
                    let tickets = 0;
                    
                    if (this.trainingModes.steady) {
                        crystal += 100;
                        tickets += 1;
                    }
                    if (this.trainingModes.fluctuating) {
                        crystal += 200;
                        tickets += 2;
                    }
                    if (this.trainingModes.outOfControl) {
                        crystal += 200;
                    }
                    if (this.trainingModes.crazy) {
                        crystal += 60;
                    }
                    
                    return {
                        crystal,
                        tickets,
                        total: crystal + (tickets * 180)
                    };
                },
                
                nightmareTotalRewards() {
                    const scoreRewards = this.calculateNightmareRewards();
                    return {
                        crystal: scoreRewards.crystal,  // 修改：移除祸海之厄的异方晶
                        tickets: scoreRewards.tickets,
                        total: scoreRewards.crystal + (scoreRewards.tickets * 180)  // 修改：移除祸海之厄的异方晶
                    };
                },
                
                dataGapRewards() {
                    let crystal = 0;
                    
                    if (this.dataGap.targets.missionComplete) crystal += 300;
                    if (this.dataGap.targets.missionCount) crystal += 120;
                    if (this.dataGap.targets.targetComplete) crystal += 140;
                    
                    if (this.dataGap.ratings.healing) crystal += 100;
                    if (this.dataGap.ratings.shield) crystal += 100;
                    if (this.dataGap.ratings.controlTime) crystal += 100;
                    if (this.dataGap.ratings.controlCount) crystal += 100;
                    if (this.dataGap.ratings.totalDamage) crystal += 100;
                    if (this.dataGap.ratings.coreDamage) crystal += 100;
                    if (this.dataGap.ratings.comprehensive) crystal += 100;
                    
                    return crystal;
                },

                // 新增模块奖励计算
                mainStoryRewards() {
                    let crystal = 0;
                    let tickets = 0;
                    
                    if (this.mainStory.chaosBeyondA) { crystal += 995; tickets += 1; }
                    if (this.mainStory.chaosBeyondB) { crystal += 1230; tickets += 1; }
                    if (this.mainStory.unownedCavernA) { crystal += 1175; tickets += 1; }
                    if (this.mainStory.unownedCavernB) { crystal += 1280; tickets += 1; }
                    if (this.mainStory.kiranSquareA) { crystal += 1265; tickets += 1; }
                    if (this.mainStory.kiranSquareB) { crystal += 1230; tickets += 1; }
                    if (this.mainStory.carnivalA) { crystal += 1230; tickets += 1; }
                    if (this.mainStory.carnivalB) { crystal += 935; tickets += 1; }
                    if (this.mainStory.refugeeCampA) { crystal += 1125; tickets += 1; }
                    if (this.mainStory.refugeeCampB) { crystal += 1195; tickets += 1; }
                    if (this.mainStory.muddyDarkTrapA) { crystal += 1230; tickets += 1; }
                    if (this.mainStory.muddyDarkTrapB) { crystal += 605; tickets += 1; }
                    if (this.mainStory.highTowerBlackRing) { crystal += 1980; tickets += 2; }
                    if (this.mainStory.darkSurgeA) { crystal += 1005; tickets += 1; }
                    if (this.mainStory.darkSurgeB) { crystal += 1005; tickets += 1; }
                    if (this.mainStory.goldFeastA) { crystal += 900; tickets += 1; }
                    if (this.mainStory.goldFeastB) { crystal += 1180; tickets += 1; }
                    
                    return {
                        crystal,
                        tickets,
                        total: crystal + (tickets * 180)
                    };
                },

                actionSummaryText() {
                    if (this.actionSummaryLevel >= 19) {
                        return "已完成全部行动纪要";
                    }
                    return this.actionSummaryList[this.actionSummaryLevel] || "01·混沌彼岸";
                },

                // 狄斯暗影（EX）奖励计算
                darkShadowExRewards() {
                    let crystal = 0;
                    
                    if (this.darkShadowEx.chaosBeyond) crystal += 720;
                    if (this.darkShadowEx.unownedCavern) crystal += 720;
                    if (this.darkShadowEx.kiranSquare) crystal += 590;
                    if (this.darkShadowEx.carnival) crystal += 650;
                    if (this.darkShadowEx.highTowerBlackRing) crystal += 650;
                    if (this.darkShadowEx.luxuryFeastFog) crystal += 650;
                    if (this.darkShadowEx.drowningRainCity) crystal += 650;
                    if (this.darkShadowEx.goldFeast) crystal += 650;
                    
                    return crystal;
                },

                memoryStormRewards() {
                    let crystal = 0;
                    
                    if (this.memoryStorm.memoryAnomaly) crystal += 350;
                    if (this.memoryStorm.impressionAnomaly) crystal += 350;
                    if (this.memoryStorm.echoAnomaly) crystal += 350;
                    
                    return crystal;
                },

                pollutionNestRewards() {
                    let crystal = 0;
                    
                    if (this.pollutionNest.forbiddenZoneProbe) crystal += 350;
                    if (this.pollutionNest.extremeDomainSearch) crystal += 210;
                    
                    return crystal;
                },

                cleanupOperationRewards() {
                    let crystal = 0;
                    
                    if (this.cleanupOperation.goldRush) crystal += 350;
                    if (this.cleanupOperation.ominousSeed) crystal += 350;
                    
                    return crystal;
                },

                palmaRuinsRewards() {
                    let crystal = 0;
                    
                    if (this.palmaRuins.tenacious) crystal += 280;
                    if (this.palmaRuins.berserk) crystal += 280;
                    if (this.palmaRuins.mysterious) crystal += 280;
                    if (this.palmaRuins.precise) crystal += 280;
                    if (this.palmaRuins.supernatural) crystal += 280;
                    if (this.palmaRuins.inspiration) crystal += 280;
                    
                    return crystal;
                },

                // 角色养成模块奖励计算
                characterDevelopmentRewards() {
                    let crystal = 0;
                    
                    crystal += this.characterDevelopment.tier3 * 180;
                    crystal += this.characterDevelopment.maxReverbS * 210;
                    crystal += this.characterDevelopment.maxReverbA * 60;
                    crystal += this.characterDevelopment.maxReverbB * 20;
                    crystal += this.characterDevelopment.reviewS * 200;
                    crystal += this.characterDevelopment.reviewA * 150;
                    
                    if (!this.characterDevelopment.haylaReviewed) {
                        crystal += 100;
                    }
                    
                    return {
                        crystal,
                        total: crystal
                    };
                },

                totalNewModuleRewards() {
                    return this.mainStoryRewards.total + 
                           this.darkShadowExRewards + 
                           this.memoryStormRewards + 
                           this.pollutionNestRewards + 
                           this.cleanupOperationRewards + 
                           this.palmaRuinsRewards +
                           this.characterDevelopmentRewards.total;
                },
                
                // 分模块计算 - 日常积累
                dailyAccumulationCrystal() {
                    return this.dailyActiveTotal + 
                        this.totalWeeklyActive + 
                        this.totalDarkZone +
                        this.totalDarkZoneFirst +
                        this.totalEmotionDetectionForSummary +
                        this.totalSignInRewardForSummary +
                        this.totalDailyShare +
                        this.nightmareSeaReward;  // 新增：将祸海之厄的异方晶计入日常积累
                },


                // 分模块计算 - 商店兑换
                shopExchangeCrystal() {
                    return (this.totalTrackingExchange * 180) +
                        (this.totalFriendshipExchange * 180) +
                        this.totalTrackingCertification;
                },

                // 复刻活动异方晶奖励
                activityRerunCrystal() {
                    let totalCrystal = 0;
                    this.displayActivities.forEach(activity => {
                        if (this.activityRerunMode[activity.title] === 'crystal') {
                            totalCrystal += 1000;
                        }
                    });
                    return totalCrystal;
                },

                // 复刻活动搜索令奖励
                activityRerunTickets() {
                    let totalTickets = 0;
                    this.displayActivities.forEach(activity => {
                        if (this.activityRerunMode[activity.title] === 'crystal') {
                            totalTickets += 3;
                        } else if (this.activityRerunMode[activity.title] === 'ticket') {
                            totalTickets += 1;
                        }
                    });
                    return totalTickets;
                },

                // 单个活动的复刻活动异方晶显示
                activityRerunCrystalDisplay(activityTitle) {
                    if (this.activityRerunMode[activityTitle] === 'crystal') {
                        return 1000;
                    }
                    return 0;
                },

                // 单个活动的复刻活动搜索令显示
                activityRerunTicketsDisplay(activityTitle) {
                    if (this.activityRerunMode[activityTitle] === 'crystal') {
                        return 3;
                    } else if (this.activityRerunMode[activityTitle] === 'ticket') {
                        return 1;
                    }
                    return 0;
                },

                // 分模块计算 - 活动奖励
                activityRewardsCrystal() {
                    let activityCrystal = 0;
                    let activityTickets = 0;
                    let activityReviewCrystal = 0;
                    let activityTrialCrystal = 0;

                    // 计算所有未完成活动的奖励
                    this.displayActivities.forEach(activity => {
                        if (!this.activityCompleted[activity.title]) {
                            if (activity.title === '妄夜迷章') {
                                activityCrystal += 1070;
                                activityTickets += 3;
                            } else if (activity.title === '主线版本（⚠️估算）') {
                                activityCrystal += 2000;
                                activityTickets += 5;
                            } else {
                                activityCrystal += 1000;
                                activityTickets += 3;
                            }
                        }

                        // 计算审查奖励
                        if (!this.activityReviewCompleted[activity.title]) {
                            if (activity.title === '新年活动（⚠️估算）') {
                                activityReviewCrystal += 550;
                            } else {
                                activityReviewCrystal += 350;
                            }
                        }

                        // 计算角色试用奖励
                        if (!this.activityTrialCompleted[activity.title]) {
                            if (activity.title === '主线版本（⚠️估算）' || activity.title === '新年活动（⚠️估算）') {
                                activityTrialCrystal += 70;
                            } else {
                                activityTrialCrystal += 40;
                            }
                        }
                    });

                    return activityCrystal + 
                        activityReviewCrystal + 
                        activityTrialCrystal +
                        this.activityRerunCrystal; // 新增：复刻活动异方晶
                },

                // 分模块计算 - 活动搜索令
                activityRewardsTickets() {
                    let activityTickets = 0;
                    let activitySignInTickets = 0;

                    // 计算所有未完成活动的搜索令
                    this.displayActivities.forEach(activity => {
                        if (!this.activityCompleted[activity.title]) {
                            if (activity.title === '主线版本（⚠️估算）') {
                                activityTickets += 5;
                            } else {
                                activityTickets += 3;
                            }
                        }                        
                    });

                    return activityTickets + activitySignInTickets + this.activityRerunTickets; // 新增：复刻活动搜索令
                },

                // 分模块计算 - 其他系统
                otherSystemsCrystal() {
                    return this.trainingRewards.total +
                        this.nightmareRemainingCrystal +  // 无尽梦魇异方晶
                        this.dataGapRewards +
                        this.totalNewModuleRewards +
                        this.actionSummaryCrystal;
                },

                // 分模块计算 - 氪金资源
                rechargeCrystal() {
                    return this.monthlyCardCrystal +
                        this.rechargeInspectionOrderCrystal +
                        (this.disiActive ? this.disiRewardTotal : 0);
                },

                // 总计 - 替换原来的 totalCrystalIncome
                totalCrystalIncome() {
                    return this.dailyAccumulationCrystal +
                        this.shopExchangeCrystal +
                        this.activityRewardsCrystal +
                        this.otherSystemsCrystal +
                        this.rechargeCrystal +
                        this.previewCodeCrystal + // 新增：前瞻兑换码异方晶
                        this.maintenanceCrystal + // 停服更新异方晶
                        this.maintenanceRepairCrystal; // 停服维护异方晶
                },

                totalSkinReserve() {
                    return (this.skinReserve.skin880 * 880) + 
                           (this.skinReserve.skin1280 * 1280) + 
                           (this.skinReserve.skin2580 * 2580);
                },
                
                currentPulls() {
                    const crystal = this.resources.crystal || 0;
                    const premiumCrystal = this.usePremiumCrystal ? (this.resources.premiumCrystal || 0) : 0;
                    const tickets = this.resources.tickets || 0;
                    
                    // 添加月卡璀璨晶源到可用资源中
                    const monthlyCardPremiumCrystal = this.monthlyCardPremiumCrystal;
                    
                    const availableCrystal = crystal + (premiumCrystal + monthlyCardPremiumCrystal) - this.totalSkinReserve + this.customAdjustment;
                    const crystalPulls = Math.floor(Math.max(0, availableCrystal) / 180);
                    return crystalPulls + tickets;
                },
                
                totalCrystal() {
                    const crystal = this.resources.crystal || 0;
                    const premiumCrystal = this.usePremiumCrystal ? (this.resources.premiumCrystal || 0) : 0;
                    const tickets = this.resources.tickets || 0;
                    
                    // 添加月卡璀璨晶源到可用资源中
                    const monthlyCardPremiumCrystal = this.monthlyCardPremiumCrystal;
                    
                    return crystal + (premiumCrystal + monthlyCardPremiumCrystal) + (tickets * 180) + this.totalCrystalIncome - this.totalSkinReserve + this.customAdjustment;
                },
                
                additionalPulls() {
                    return Math.floor(this.totalCrystalIncome / 180);
                },
                
                futurePulls() {
                    return this.currentPulls + this.additionalPulls;
                },
                
                totalCrystalSummary() {
                    const baseCrystal = this.resources.crystal || 0;
                    const totalIncome = this.totalCrystalIncome;
                    
                    return baseCrystal + totalIncome + this.customAdjustment;
                },

                // 璀璨晶源总计（包含狄斯盈满钵的璀璨晶源）
                totalPremiumCrystalSummary() {
                    const basePremiumCrystal = this.resources.premiumCrystal || 0;
                    const monthlyCardPremium = this.monthlyCardPremiumCrystal;
                    const disiPremium = this.disiPremiumCrystal;
                    
                    return basePremiumCrystal + monthlyCardPremium + disiPremium - this.totalSkinReserve;
                },
                
                // 分模块计算 - 基础搜索令
                baseTicketsSummary() {
                    return this.resources.tickets || 0;
                },

                // 分模块计算 - 日常积累搜索令
                dailyAccumulationTickets() {
                    return this.totalTrackingExchange + 
                        this.totalFriendshipExchange + 
                        this.totalEmotionDetectionTicketsForSummary +
                        this.totalSignInRewardTicketsForSummary +
                        this.totalTrackingCertificationTickets +
                        this.dailyInspectionOrderTickets;
                },

                // 分模块计算 - 其他系统搜索令
                otherSystemsTickets() {
                    return this.trainingRewards.tickets +
                        this.nightmareTotalRewards.tickets +
                        this.mainStoryRewards.tickets;
                },

                // 分模块计算 - 氪金搜索令
                rechargeTickets() {
                    return this.rechargeInspectionOrderTickets +
                        this.treasureTickets;
                },

                // 总计 - 替换原来的 totalTicketsSummary
                totalTicketsSummary() {
                    return this.baseTicketsSummary +
                        this.dailyAccumulationTickets +
                        this.activityRewardsTickets +
                        this.otherSystemsTickets +
                        this.rechargeTickets +
                        this.signInRewardTickets; // 添加其他模块的搜索令
                },

                monthlyCardPremiumCrystal() {
                    if (!this.monthlyCardActive) return 0;
                    
                    // -1表示提前购买，璀璨晶源为0；0及以上按正常计算
                    if (this.monthlyCardCount === -1) return 0;
                    
                    // 基础月卡给300，每额外购买1张月卡额外给300
                    const baseCard = 1; // 基础月卡
                    const additionalCards = Math.max(0, this.monthlyCardCount); // 额外购买的月卡数量
                    
                    return (baseCard + additionalCards) * 300;
                },

                monthlyCardCrystal() {
                    if (!this.monthlyCardActive) return 0;
                    
                    const days = this.selectedDays;
                    const crystalPerDay = 60;
                    
                    // 计算总月卡天数
                    let totalCardDays = 0;
                    
                    if (this.monthlyCardCount === -1) {
                        // -1：提前购买，有1张月卡30天
                        totalCardDays = 30;
                    } else if (this.monthlyCardCount >= 0) {
                        // 0：购买1张月卡30天，1：购买2张月卡60天，以此类推
                        totalCardDays = 30 * (this.monthlyCardCount + 1);
                    }
                    
                    // 实际可用的月卡天数不能超过剩余天数
                    const actualCardDays = Math.min(totalCardDays, days);
                    
                    return actualCardDays * crystalPerDay;
                },

                monthlyCardCost() {
                    if (!this.monthlyCardActive) return 0;
                    
                    // -1表示提前购买，不算入氪金金额
                    if (this.monthlyCardCount === -1) return 0;
                    
                    // 0表示购买1张，1表示购买2张，以此类推
                    const totalCards = this.monthlyCardCount + 1;
                    return totalCards * 30; // 每张月卡30RMB
                },

                inspectionOrderCost() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // -1表示提前购买，不算入氪金金额
                    if (this.inspectionOrderCount === -1) return 0;
                    
                    // 0表示购买1期，1表示购买2期，以此类推
                    const totalPeriods = this.inspectionOrderCount + 1;
                    return totalPeriods * 68; // 每期68RMB
                },

                disiCost() {
                    // 只有当按钮激活且未预先购买时才计入98RMB
                    if (this.disiActive && !this.disiPrePurchased) {
                        return 98;
                    }
                    return 0;
                },

                treasureCost() {
                    // 只有当按钮激活且未预先购买时才计入88RMB
                    if (this.treasureActive && !this.treasurePrePurchased) {
                        return 88;
                    }
                    return 0;
                },            

                totalRechargeCost() {
                    return this.monthlyCardCost + this.inspectionOrderCost + this.disiCost + this.treasureCost;
                },

                inspectionOrderCrystal() {
                    // 如果滑块在55级，代表本期奖励已领完，只计算过往期数
                    if (this.inspectionOrderLevel >= 55) {
                        const periods = this.calculateInspectionPeriods - 1;
                        const totalPerPeriod = 200 + 680; // 每期总共880异方晶
                        return periods * totalPerPeriod;
                    }
                    
                    // 日常积累模块中的监察密令只计算异方晶和搜索令，不计算RMB
                    let crystal = 0;
                    // 计算大于当前等级的奖励（本期剩余奖励）
                    if (this.inspectionOrderLevel < 30) crystal += 200;
                    if (this.inspectionOrderLevel < 50) crystal += 680;
                    
                    // 总奖励 = 本期剩余奖励 + (期数-1) * 每期总奖励
                    const periods = this.calculateInspectionPeriods;
                    const totalPerPeriod = 200 + 680; // 每期总共880异方晶
                    
                    return crystal + (periods - 1) * totalPerPeriod;
                },

                inspectionOrderTickets() {
                    // 如果滑块在55级，代表本期奖励已领完，只计算过往期数
                    if (this.inspectionOrderLevel >= 55) {
                        const periods = this.calculateInspectionPeriods - 1;
                        const totalPerPeriod = 6; // 每期总共6搜索令
                        return periods * totalPerPeriod;
                    }
                    
                    // 日常积累模块中的监察密令只计算异方晶和搜索令，不计算RMB
                    let tickets = 0;
                    const levels = [5, 15, 25, 35, 45, 55];
                    
                    // 计算大于当前等级的奖励（本期剩余奖励）
                    for (const level of levels) {
                        if (this.inspectionOrderLevel < level) {
                            tickets += 1; // 日常积累模块固定为普通监察密令，每级1张
                        }
                    }
                    
                    // 总奖励 = 本期剩余奖励 + (期数-1) * 每期总奖励
                    const periods = this.calculateInspectionPeriods;
                    const totalPerPeriod = 6; // 每期总共6搜索令
                    
                    return tickets + (periods - 1) * totalPerPeriod;
                },

                inspectionOrderCost() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 负数代表已提前购买，不算入氪金金额
                    if (this.inspectionOrderCount < 0) return 0;
                    
                    // 基础1期 + 额外购买期数
                    const totalPeriods = 1 + Math.max(0, this.inspectionOrderCount);
                    return totalPeriods * 68;
                },

                rechargeInspectionOrderCrystal() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 直接计算总期数，避免方法调用
                    const basePeriods = 1;
                    const additionalPeriods = Math.max(0, this.inspectionOrderCount);
                    const totalPeriods = basePeriods + additionalPeriods;
                    
                    // 每期880异方晶
                    return totalPeriods * 880;
                },

                rechargeInspectionOrderTickets() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 直接计算总期数，避免方法调用
                    const basePeriods = 1;
                    const additionalPeriods = Math.max(0, this.inspectionOrderCount);
                    const totalPeriods = basePeriods + additionalPeriods;
                    
                    // 每期6搜索令
                    return totalPeriods * 6;
                },

                // 高级监察密令异方晶数量计算
                inspectionOrderCrystalAmount() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 计算总期数
                    const basePeriods = 1; // 基础1期
                    const additionalPeriods = Math.max(0, this.inspectionOrderCount); // 额外购买期数
                    const totalPeriods = basePeriods + additionalPeriods;
                    
                    // 每期880异方晶
                    return totalPeriods * 880;
                },

                // 高级监察密令搜索令数量计算
                inspectionOrderTicketAmount() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 计算总期数
                    const basePeriods = 1; // 基础1期
                    const additionalPeriods = Math.max(0, this.inspectionOrderCount); // 额外购买期数
                    const totalPeriods = basePeriods + additionalPeriods;
                    
                    // 每期6搜索令
                    return totalPeriods * 6;
                },

                calculateInspectionPeriods() {
                    // 监察密令固定周期计算：每6周1期
                    
                    const today = new Date();
                    const versionDate = this.selectedTime === 'nextVersion' 
                        ? this.poolDates.nextVersion
                        : this.poolDates.newYear;
                    
                    // 密令开始日期（当前周期开始）
                    const firstOrderStart = new Date(2025, 9, 6); // 2025年10月6日
                    
                    // 计算从第一个密令开始到目标日期的周数
                    const diffTime = versionDate - firstOrderStart;
                    const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
                    
                    // 每6周为1期，计算期数（向上取整）
                    const totalPeriods = Math.ceil(diffWeeks / 6);
                    
                    // 计算从今天到第一个密令开始的周数，确定当前期数
                    const currentDiffTime = today - firstOrderStart;
                    const currentDiffWeeks = Math.ceil(currentDiffTime / (1000 * 60 * 60 * 24 * 7));
                    const currentPeriod = Math.ceil(currentDiffWeeks / 6);
                    
                    // 经历的期数 = 总期数 - 当前期 + 1
                    const periods = totalPeriods - currentPeriod + 1;
                    
                    return Math.max(1, periods); // 至少1期
                },
                // 日常积累模块的异方晶计算
                dailyInspectionOrderCrystal() {
                    let crystal = 0;
                    // 计算大于当前等级的奖励（本期剩余奖励）
                    if (this.dailyInspectionOrderLevel < 30) crystal += 200;
                    if (this.dailyInspectionOrderLevel < 50) crystal += 680;
                    
                    // 总奖励 = 本期剩余奖励 + (期数-1) * 每期总奖励
                    const periods = this.calculateInspectionPeriods;
                    const totalPerPeriod = 200 + 680; // 每期总共880异方晶
                    
                    return crystal + (periods - 1) * totalPerPeriod;
                },

                // 氪金模块的异方晶计算
                rechargeInspectionOrderCrystal() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 直接计算总期数，避免方法调用
                    const basePeriods = 1;
                    const additionalPeriods = Math.max(0, this.inspectionOrderCount);
                    const totalPeriods = basePeriods + additionalPeriods;
                    
                    // 每期880异方晶
                    return totalPeriods * 880;
                },

                rechargeInspectionOrderTickets() {
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 直接计算总期数，避免方法调用
                    const basePeriods = 1;
                    const additionalPeriods = Math.max(0, this.inspectionOrderCount);
                    const totalPeriods = basePeriods + additionalPeriods;
                    
                    // 每期6搜索令
                    return totalPeriods * 6;
                },

                rechargeInspectionOrderCost() {  // 改名避免冲突
                    if (!this.inspectionOrderActive) return 0;
                    
                    // 负数代表已提前购买，不算入氪金金额
                    if (this.inspectionOrderCount < 0) return 0;
                    
                    // 基础1期 + 额外购买期数
                    const totalPeriods = 1 + Math.max(0, this.inspectionOrderCount);
                    return totalPeriods * 68;
                },

                // 狄斯盈满钵奖励计算
                disiRewardTotal() {
                    // 计算大于当前等级的所有奖励总和
                    let total = 0;
                    for (const reward of this.disiRewards) {
                        if (reward.level <= this.disiLevel) {
                            total += reward.crystal;
                        }
                    }
                    return total;
                },

                // 狄斯盈满钵璀璨晶源计算
                disiPremiumCrystal() {
                    // 只要按钮激活就显示980璀璨晶源，预购买只影响费用计算
                    if (this.disiActive) {
                        return 980;
                    }
                    return 0;
                },        

                // 诡珑珍宝馆搜索令计算
                treasureTickets() {
                    // 只有当按钮激活时才显示10搜索令
                    if (this.treasureActive) {
                        return 10;
                    }
                    return 0;
                },

            },
            watch: {
                resources: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                selectedTime() {
                    // 当切换时间时，检查并调整高级监察密令购买数量
                    const maxLimit = this.calculateInspectionPeriods - 1;
                    if (this.inspectionOrderCount > maxLimit) {
                        this.inspectionOrderCount = maxLimit;
                    }
                    this.saveToLocalStorage();
                },
                calculateToPoolEnd() {
                    this.saveToLocalStorage();
                },
                weeklyCompleted() {
                    this.saveToLocalStorage();
                },
                darkZoneSweepOnly() {
                    this.saveToLocalStorage();
                },
                darkZoneCompleted() {
                    this.saveToLocalStorage();
                },
                darkZoneFirstCompleted() {
                    this.saveToLocalStorage();
                },
                trackingExchanged() {
                    this.saveToLocalStorage();
                },
                friendshipExchanged() {
                    this.saveToLocalStorage();
                },
                usePremiumCrystal() {
                    this.saveToLocalStorage();
                },
                skinReserve: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                customAdjustment() {
                    this.saveToLocalStorage();
                },
                emotionDetectionCompleted() {
                    this.saveToLocalStorage();
                },
                signInRewardCompleted() {
                    this.saveToLocalStorage();
                },
                dailyShareCompleted() {
                    this.saveToLocalStorage();
                },
                trackingCertificationCount() {
                    this.saveToLocalStorage();
                },
                useTrackingCertification() {
                    this.saveToLocalStorage();
                },
                trainingModes: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                nightmareScore() {
                    this.saveToLocalStorage();
                },
                nightmareSeaCompleted() {
                    this.saveToLocalStorage();
                },
                dataGap: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                // 新增模块的watch
                mainStory: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                darkShadowEx: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                memoryStorm: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                pollutionNest: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                cleanupOperation: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                palmaRuins: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                // 角色养成模块的watch
                characterDevelopment: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },
                monthlyCardCount() {
                    this.saveToLocalStorage();
                },
                
                monthlyCardActive() {
                    this.saveToLocalStorage();
                },

                inspectionOrderActive() {
                    this.saveToLocalStorage();
                },
                inspectionOrderCount() {
                    this.saveToLocalStorage();
                },

                rechargeInspectionOrderLevel() {
                    this.saveToLocalStorage();
                },

                actionSummaryLevel() {
                    this.saveToLocalStorage();
                },

                disiLevel() {
                    this.saveToLocalStorage();
                },

                disiActive() {
                    this.saveToLocalStorage();
                },

                disiPrePurchased() {
                    this.saveToLocalStorage();
                },

                treasureActive() {
                    this.saveToLocalStorage();
                },

                treasurePrePurchased() {
                    this.saveToLocalStorage();
                },

                // 新增：活动完成状态监听
                activityCompleted: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },

                // 新增：活动审查奖励完成状态监听
                activityReviewCompleted: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },

                // 新增：活动角色试用奖励完成状态监听
                activityTrialCompleted: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },

                // 新增折叠状态监听
                sections: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },

                // 新增：活动复刻模式状态监听
                activityRerunMode: {
                    handler(newValue) {
                        this.saveToLocalStorage();
                    },
                    deep: true
                },

            },
            methods: {
                saveToLocalStorage() {
                    const dataToSave = {
                        ections: this.sections, // 新增：保存折叠状态
                        resources: this.resources,
                        selectedTime: this.selectedTime,
                        calculateToPoolEnd: this.calculateToPoolEnd,
                        weeklyCompleted: this.weeklyCompleted,
                        darkZoneSweepOnly: this.darkZoneSweepOnly,
                        darkZoneCompleted: this.darkZoneCompleted,
                        darkZoneFirstCompleted: this.darkZoneFirstCompleted,
                        trackingExchanged: this.trackingExchanged,
                        friendshipExchanged: this.friendshipExchanged,
                        usePremiumCrystal: this.usePremiumCrystal,
                        skinReserve: this.skinReserve,
                        customAdjustment: this.customAdjustment,
                        emotionDetectionCompleted: this.emotionDetectionCompleted,
                        signInRewardCompleted: this.signInRewardCompleted,
                        dailyShareCompleted: this.dailyShareCompleted,
                        trackingCertificationCount: this.trackingCertificationCount,
                        useTrackingCertification: this.useTrackingCertification,
                        trainingModes: this.trainingModes,
                        nightmareScore: this.nightmareScore,
                        nightmareSeaCompleted: this.nightmareSeaCompleted,
                        dataGap: this.dataGap,
                        // 新增模块数据保存
                        mainStory: this.mainStory,
                        darkShadowEx: this.darkShadowEx,
                        memoryStorm: this.memoryStorm,
                        pollutionNest: this.pollutionNest,
                        cleanupOperation: this.cleanupOperation,
                        palmaRuins: this.palmaRuins,
                        // 角色养成模块数据保存
                        characterDevelopment: this.characterDevelopment,
                        monthlyCardCount: this.monthlyCardCount,
                        monthlyCardActive: this.monthlyCardActive,
                        inspectionOrderActive: this.inspectionOrderActive,
                        inspectionOrderLevel: this.inspectionOrderLevel,
                        actionSummaryLevel: this.actionSummaryLevel,
                        inspectionOrderCount: this.inspectionOrderCount,
                        dailyInspectionOrderLevel: this.dailyInspectionOrderLevel,
                        rechargeInspectionOrderLevel: this.rechargeInspectionOrderLevel,
                        disiLevel: this.disiLevel,  // 添加狄斯盈满钵等级
                        disiActive: this.disiActive, // 添加狄斯盈满钵激活状态
                        disiPrePurchased: this.disiPrePurchased, // 添加狄斯盈满钵预购买
                        treasureActive: this.treasureActive, // 添加诡珑珍宝馆激活状态
                        treasurePrePurchased: this.treasurePrePurchased, // 添加诡珑珍宝馆预购买状态
                        activityCompleted: this.activityCompleted,//活动数据
                        activityReviewCompleted: this.activityReviewCompleted, // 保存活动审查奖励状态
                        activityTrialCompleted: this.activityTrialCompleted, // 保存活动角色试用奖励状态
                        activityRerunMode: this.activityRerunMode, // 保存活动复刻模式状态
                    };
                    
                    try {
                        localStorage.setItem('gachaCalculatorData', JSON.stringify(dataToSave));
                    } catch (e) {
                        console.error('保存数据失败:', e);
                    }
                },

                // 新增：验证角色养成输入
                validateCharacterDevInput(type) {
                    if (this.characterDevelopment[type] < 0) {
                        this.characterDevelopment[type] = 0;
                    }
                    if (this.characterDevelopment[type] !== null && this.characterDevelopment[type] !== undefined) {
                        this.characterDevelopment[type] = Math.floor(this.characterDevelopment[type]);
                    }
                },

                // 新增：当角色养成输入框获得焦点时，如果值为0则清空
                clearCharacterDevIfZero(type) {
                    if (this.characterDevelopment[type] === 0) {
                        this.characterDevelopment[type] = null;
                    }
                },

                // 新增：当角色养成输入框失去焦点时，如果为空则设置为0
                setCharacterDevDefaultIfEmpty(type) {
                    if (this.characterDevelopment[type] === null || this.characterDevelopment[type] === '') {
                        this.characterDevelopment[type] = 0;
                    }
                },

                // 新增：当输入框获得焦点时，如果值为0则清空
                clearIfZero(type) {
                    if (this.resources[type] === 0) {
                        this.resources[type] = null;
                    }
                },

                // 新增：当输入框失去焦点时，如果为空则设置为0
                setDefaultIfEmpty(type) {
                    if (this.resources[type] === null || this.resources[type] === '') {
                        this.resources[type] = 0;
                    }
                },

                // 获取模块名称的缩写（用于移动端显示）
                getShortModuleName(fullName) {
                    const nameMap = {
                        '现有': '现',
                        '日常': '日', 
                        '活动': '活',
                        '潜在': '潜',
                        '氪金': '氪',
                        '其他': '其'
                    };
                    return nameMap[fullName] || fullName.charAt(0);
                },

                // 处理饼状图触摸开始事件
                handlePieChartTouchStart(event) {
                    this.handlePieChartTouch(event);
                },

                // 处理饼状图触摸移动事件  
                handlePieChartTouchMove(event) {
                    this.handlePieChartTouch(event);
                },

                // 处理饼状图触摸结束事件
                handlePieChartTouchEnd() {
                    // 触摸结束时不清除悬停状态，保持显示
                },

                // 统一的触摸事件处理
                handlePieChartTouch(event) {
                    const canvas = this.$refs.pieChart;
                    if (!canvas) return;
                    
                    const touch = event.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const baseRadius = Math.min(canvas.width, canvas.height) / 2 - 20;
                    const separation = 5;
                    
                    // 计算触摸位置相对于圆心的角度
                    const angle = Math.atan2(y - centerY, x - centerX);
                    const normalizedAngle = angle < 0 ? angle + 2 * Math.PI : angle;
                    
                    let currentAngle = 0;
                    let hoveredModule = null;
                    let hoveredIndex = -1;
                    
                    // 查找触摸所在的扇形区域
                    this.pieChartData.forEach((module, index) => {
                        if (module.pulls > 0) {
                            const sliceAngle = (module.pulls / this.totalModulePulls) * 2 * Math.PI;
                            const midAngle = currentAngle + sliceAngle / 2;
                            
                            // 计算偏移后的圆心
                            const offsetX = Math.cos(midAngle) * separation;
                            const offsetY = Math.sin(midAngle) * separation;
                            const offsetCenterX = centerX + offsetX;
                            const offsetCenterY = centerY + offsetY;
                            
                            // 计算该区域的最大半径
                            const maxRadius = index === this.hoveredPieIndex ? baseRadius + 12 : baseRadius + 8;
                            
                            if (normalizedAngle >= currentAngle && normalizedAngle <= currentAngle + sliceAngle) {
                                // 检查触摸是否在扇形区域内
                                const distance = Math.sqrt(Math.pow(x - offsetCenterX, 2) + Math.pow(y - offsetCenterY, 2));
                                if (distance <= maxRadius) {
                                    hoveredModule = module;
                                    hoveredIndex = index;
                                }
                            }
                            currentAngle += sliceAngle;
                        }
                    });
                    
                    // 更新悬停状态
                    this.hoveredPieModule = hoveredModule;
                    this.hoveredPieIndex = hoveredIndex;
                    
                    // 重绘饼状图以显示悬停效果
                    this.drawPieChart();
                },

                // 验证饼状图总计与顶部总计是否一致
                validatePieChartTotal() {
                    const pieTotal = this.totalModulePulls;
                    const headerTotal = this.totalPulls;
                    
                    if (pieTotal !== headerTotal) {
                        console.warn(`数据不一致: 饼状图总计=${pieTotal}, 顶部总计=${headerTotal}`);
                        console.log('饼状图模块详情:', this.modulePullsData);
                        console.log('顶部总计详情:', {
                            crystalPulls: Math.floor(this.totalCrystalSummary / 180),
                            premiumCrystalPulls: Math.floor(this.totalPremiumCrystalSummary / 180),
                            ticketPulls: this.totalTicketsSummary,
                            limitedCouponPulls: this.totalLimitedCouponsSummary
                        });
                    }
                    
                    return pieTotal === headerTotal;
                },

                // 绘制饼状图 - 悬停时只放大当前区块
                drawPieChart() {
                    const canvas = this.$refs.pieChart;
                    if (!canvas) return;
                    
                    // 高DPI适配
                    const dpr = window.devicePixelRatio || 1;
                    const container = canvas.parentElement;
                    const rect = container.getBoundingClientRect();
                    const width = rect.width;
                    const height = rect.height;
                    
                    // 设置canvas尺寸
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    canvas.style.width = width + 'px';
                    canvas.style.height = height + 'px';
                    
                    const ctx = canvas.getContext('2d');
                    
                    // 增强抗锯齿设置
                    ctx.scale(dpr, dpr);
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // 设置高质量渲染
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1;
                    
                    // 清空画布
                    ctx.clearRect(0, 0, width, height);
                    
                    // 计算中心点和半径
                    const isMobile = window.innerWidth <= 768;
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const baseRadius = Math.min(width, height) / (isMobile ? 3 : 3.2);
                    
                    // 找出占比最大的模块
                    let maxPulls = 0;
                    let maxIndex = -1;
                    this.pieChartData.forEach((module, index) => {
                        if (module.pulls > maxPulls) {
                            maxPulls = module.pulls;
                            maxIndex = index;
                        }
                    });
                    
                    let startAngle = 0;
                    const separation = isMobile ? 2 : 5;
                    
                    // 绘制阴影效果（底层）
                    this.pieChartData.forEach((module, index) => {
                        if (module.pulls > 0) {
                            const sliceAngle = (module.pulls / this.totalModulePulls) * 2 * Math.PI;
                            const midAngle = startAngle + sliceAngle / 2;
                            
                            const offsetX = Math.cos(midAngle) * separation;
                            const offsetY = Math.sin(midAngle) * separation;
                            
                            let radius = baseRadius;
                            if (index === maxIndex) {
                                radius = baseRadius + (isMobile ? 2 : 4);
                            }
                            if (index === this.hoveredPieIndex) {
                                radius = baseRadius + (isMobile ? 3 : 6);
                            }
                            
                            // 绘制阴影
                            ctx.beginPath();
                            ctx.moveTo(centerX + offsetX + 1, centerY + offsetY + 1);
                            ctx.arc(centerX + offsetX + 1, centerY + offsetY + 1, radius, startAngle, startAngle + sliceAngle);
                            ctx.closePath();
                            
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                            ctx.fill();
                            
                            startAngle += sliceAngle;
                        }
                    });
                    
                    // 重置起始角度，绘制主要扇形
                    startAngle = 0;
                    
                    // 在绘制主要扇形部分使用这个改进版本
                    this.pieChartData.forEach((module, index) => {
                        if (module.pulls > 0) {
                            const sliceAngle = (module.pulls / this.totalModulePulls) * 2 * Math.PI;
                            const midAngle = startAngle + sliceAngle / 2;
                            
                            const offsetX = Math.cos(midAngle) * separation;
                            const offsetY = Math.sin(midAngle) * separation;
                            
                            let radius = baseRadius;
                            let lineWidth = isMobile ? 1.5 : 2;
                            if (index === maxIndex) {
                                radius = baseRadius + (isMobile ? 4 : 8);
                                lineWidth = isMobile ? 2.5 : 3;
                            }
                            if (index === this.hoveredPieIndex) {
                                radius = baseRadius + (isMobile ? 6 : 12);
                                lineWidth = isMobile ? 3 : 4;
                            }
                            
                            // 改进的扇形绘制 - 使用路径和填充分离
                            ctx.save(); // 保存状态
                            
                            // 创建圆形路径
                            ctx.beginPath();
                            ctx.moveTo(centerX + offsetX, centerY + offsetY);
                            ctx.arc(centerX + offsetX, centerY + offsetY, radius, startAngle, startAngle + sliceAngle);
                            ctx.closePath();
                            
                            // 设置阴影效果
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                            ctx.shadowBlur = 8;
                            ctx.shadowOffsetX = 2;
                            ctx.shadowOffsetY = 2;
                            
                            // 填充扇形
                            ctx.fillStyle = module.color;
                            ctx.fill();
                            
                            // 清除阴影
                            ctx.shadowColor = 'transparent';
                            ctx.shadowBlur = 0;
                            ctx.shadowOffsetX = 0;
                            ctx.shadowOffsetY = 0;
                            
                            // 绘制平滑边框
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                            ctx.lineWidth = lineWidth;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            ctx.stroke();
                            
                            ctx.restore(); // 恢复状态
                            
                            startAngle += sliceAngle;
                        }
                    });
                    
                    // 绘制标签和引导线
                    startAngle = 0;
                    
                    // 设置文字渲染质量
                    ctx.textRendering = 'geometricPrecision';
                    ctx.font = `bold ${isMobile ? 11 : 12}px "Microsoft YaHei", Arial, sans-serif`;
                    
                    this.pieChartData.forEach((module, index) => {
                        if (module.pulls > 0) {
                            const sliceAngle = (module.pulls / this.totalModulePulls) * 2 * Math.PI;
                            const midAngle = startAngle + sliceAngle / 2;
                            
                            const offsetX = Math.cos(midAngle) * separation;
                            const offsetY = Math.sin(midAngle) * separation;
                            
                            let radius = baseRadius;
                            if (index === maxIndex) {
                                radius = baseRadius + (isMobile ? 4 : 8);
                            }
                            if (index === this.hoveredPieIndex) {
                                radius = baseRadius + (isMobile ? 6 : 12);
                            }
                            
                            // 移动端显示完整标签
                            if (isMobile) {
                                const labelRadius = radius + 15;
                                const labelX = centerX + offsetX + Math.cos(midAngle) * labelRadius;
                                const labelY = centerY + offsetY + Math.sin(midAngle) * labelRadius;
                                
                                // 引导线
                                ctx.beginPath();
                                ctx.moveTo(
                                    centerX + offsetX + Math.cos(midAngle) * radius,
                                    centerY + offsetY + Math.sin(midAngle) * radius
                                );
                                ctx.lineTo(labelX, labelY);
                                ctx.strokeStyle = 'rgba(100, 100, 100, 0.6)';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                                
                                // 文字
                                ctx.fillStyle = '#FF6B6B';
                                ctx.textAlign = Math.cos(midAngle) > 0 ? 'left' : 'right';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(module.name, labelX + (Math.cos(midAngle) > 0 ? 5 : -5), labelY);
                            } else {
                                // 桌面端标签
                                const labelRadius = radius + 20;
                                const labelX = centerX + offsetX + Math.cos(midAngle) * labelRadius;
                                const labelY = centerY + offsetY + Math.sin(midAngle) * labelRadius;
                                
                                // 引导线
                                ctx.beginPath();
                                ctx.moveTo(
                                    centerX + offsetX + Math.cos(midAngle) * radius,
                                    centerY + offsetY + Math.sin(midAngle) * radius
                                );
                                ctx.lineTo(labelX, labelY);
                                ctx.strokeStyle = 'rgba(100, 100, 100, 0.6)';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                                
                                // 文字
                                ctx.fillStyle = '#FF6B6B';
                                ctx.textAlign = Math.cos(midAngle) > 0 ? 'left' : 'right';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(module.name, labelX + (Math.cos(midAngle) > 0 ? 5 : -5), labelY);
                            }
                            
                            startAngle += sliceAngle;
                        }
                    });
                },
                // 绘制数据标签
                drawLabel(ctx, module, angle, radius, centerX, centerY, index) {
                    const labelRadius = radius + 20;
                    const x = centerX + Math.cos(angle) * labelRadius;
                    const y = centerY + Math.sin(angle) * labelRadius;
                    
                    // 绘制连线
                    ctx.beginPath();
                    ctx.moveTo(centerX + Math.cos(angle) * radius, centerY + Math.sin(angle) * radius);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = '#999';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // 绘制文本
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = Math.cos(angle) > 0 ? 'left' : 'right';
                    ctx.textBaseline = 'middle';
                    
                    const text = module.name;
                    ctx.fillText(text, x + (Math.cos(angle) > 0 ? 5 : -5), y);
                },

                // 更新饼状图数据
                updatePieChart() {
                    this.pieChartData = this.modulePullsData.map(module => {
                        const percentage = this.totalModulePulls > 0 ? 
                            ((module.pulls / this.totalModulePulls) * 100).toFixed(1) : '0.0';
                        return {
                            ...module,
                            percentage: percentage
                        };
                    });
                    
                    // 验证数据一致性
                    this.validatePieChartTotal();
                    
                    this.$nextTick(() => {
                        this.drawPieChart();
                    });
                },
                
            // 修正鼠标悬停检测方法
            handlePieChartMouseMove(event) {
                const canvas = this.$refs.pieChart;
                if (!canvas) return;
                
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                // 修正：考虑DPI缩放的坐标转换
                const x = (event.clientX - rect.left) * (canvas.width / rect.width / dpr);
                const y = (event.clientY - rect.top) * (canvas.height / rect.height / dpr);
                
                const width = rect.width;
                const height = rect.height;
                const centerX = width / 2;
                const centerY = height / 2;
                const baseRadius = Math.min(width, height) / 2 - 20;
                const separation = window.innerWidth <= 768 ? 2 : 5;
                
                // 计算鼠标位置相对于圆心的角度
                const angle = Math.atan2(y - centerY, x - centerX);
                const normalizedAngle = angle < 0 ? angle + 2 * Math.PI : angle;
                
                let currentAngle = 0;
                let hoveredModule = null;
                let hoveredIndex = -1;
                
                // 查找鼠标所在的扇形区域
                this.pieChartData.forEach((module, index) => {
                    if (module.pulls > 0) {
                        const sliceAngle = (module.pulls / this.totalModulePulls) * 2 * Math.PI;
                        const midAngle = currentAngle + sliceAngle / 2;
                        
                        // 计算偏移后的圆心
                        const offsetX = Math.cos(midAngle) * separation;
                        const offsetY = Math.sin(midAngle) * separation;
                        const offsetCenterX = centerX + offsetX;
                        const offsetCenterY = centerY + offsetY;
                        
                        // 计算该区域的最大半径
                        let radius = baseRadius;
                        
                        // 找出占比最大的模块
                        let maxPulls = 0;
                        let maxIndex = -1;
                        this.pieChartData.forEach((m, i) => {
                            if (m.pulls > maxPulls) {
                                maxPulls = m.pulls;
                                maxIndex = i;
                            }
                        });
                        
                        if (index === maxIndex) {
                            radius = baseRadius + (window.innerWidth <= 768 ? 4 : 8);
                        }
                        if (index === this.hoveredPieIndex) {
                            radius = baseRadius + (window.innerWidth <= 768 ? 6 : 12);
                        }
                        
                        // 检查鼠标是否在扇形区域内
                        if (normalizedAngle >= currentAngle && normalizedAngle <= currentAngle + sliceAngle) {
                            // 计算到偏移圆心的距离
                            const distance = Math.sqrt(Math.pow(x - offsetCenterX, 2) + Math.pow(y - offsetCenterY, 2));
                            
                            if (distance <= radius) {
                                hoveredModule = module;
                                hoveredIndex = index;
                            }
                        }
                        currentAngle += sliceAngle;
                    }
                });
                
                // 更新悬停状态
                this.hoveredPieModule = hoveredModule;
                this.hoveredPieIndex = hoveredIndex;
                
                // 重绘饼状图以显示悬停效果
                this.drawPieChart();
            },

                // 处理饼状图鼠标离开事件
                handlePieChartMouseLeave() {
                    this.hoveredPieModule = null;
                    this.hoveredPieIndex = -1;
                    // 重绘饼状图以移除悬停效果
                    this.drawPieChart();
                },

                // 处理饼状图触摸开始事件
                handlePieChartTouchStart(event) {
                    this.handlePieChartTouch(event);
                },

                // 处理饼状图触摸移动事件  
                handlePieChartTouchMove(event) {
                    this.handlePieChartTouch(event);
                },

                // 处理饼状图触摸结束事件
                handlePieChartTouchEnd() {
                    // 触摸结束时不清除悬停状态，保持显示
                },

                // 修正触摸事件处理
                handlePieChartTouch(event) {
                    const canvas = this.$refs.pieChart;
                    if (!canvas) return;
                    
                    const touch = event.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const dpr = window.devicePixelRatio || 1;
                    
                    // 修正：考虑DPI缩放的坐标转换
                    const x = (touch.clientX - rect.left) * (canvas.width / rect.width / dpr);
                    const y = (touch.clientY - rect.top) * (canvas.height / rect.height / dpr);
                    
                    const width = rect.width;
                    const height = rect.height;
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const baseRadius = Math.min(width, height) / 2 - 20;
                    const separation = window.innerWidth <= 768 ? 2 : 5;
                    
                    // 计算触摸位置相对于圆心的角度
                    const angle = Math.atan2(y - centerY, x - centerX);
                    const normalizedAngle = angle < 0 ? angle + 2 * Math.PI : angle;
                    
                    let currentAngle = 0;
                    let hoveredModule = null;
                    let hoveredIndex = -1;
                    
                    // 查找触摸所在的扇形区域
                    this.pieChartData.forEach((module, index) => {
                        if (module.pulls > 0) {
                            const sliceAngle = (module.pulls / this.totalModulePulls) * 2 * Math.PI;
                            const midAngle = currentAngle + sliceAngle / 2;
                            
                            // 计算偏移后的圆心
                            const offsetX = Math.cos(midAngle) * separation;
                            const offsetY = Math.sin(midAngle) * separation;
                            const offsetCenterX = centerX + offsetX;
                            const offsetCenterY = centerY + offsetY;
                            
                            // 计算该区域的最大半径
                            let radius = baseRadius;
                            
                            // 找出占比最大的模块
                            let maxPulls = 0;
                            let maxIndex = -1;
                            this.pieChartData.forEach((m, i) => {
                                if (m.pulls > maxPulls) {
                                    maxPulls = m.pulls;
                                    maxIndex = i;
                                }
                            });
                            
                            if (index === maxIndex) {
                                radius = baseRadius + (window.innerWidth <= 768 ? 4 : 8);
                            }
                            if (index === this.hoveredPieIndex) {
                                radius = baseRadius + (window.innerWidth <= 768 ? 6 : 12);
                            }
                            
                            if (normalizedAngle >= currentAngle && normalizedAngle <= currentAngle + sliceAngle) {
                                // 检查触摸是否在扇形区域内
                                const distance = Math.sqrt(Math.pow(x - offsetCenterX, 2) + Math.pow(y - offsetCenterY, 2));
                                if (distance <= radius) {
                                    hoveredModule = module;
                                    hoveredIndex = index;
                                }
                            }
                            currentAngle += sliceAngle;
                        }
                    });
                    
                    // 更新悬停状态
                    this.hoveredPieModule = hoveredModule;
                    this.hoveredPieIndex = hoveredIndex;
                    
                    // 重绘饼状图以显示悬停效果
                    this.drawPieChart();
                },

                // 设置活动复刻模式
                setActivityRerunMode(activityTitle, mode) {
                    // 如果点击已经激活的按钮，则取消选择
                    if (this.activityRerunMode[activityTitle] === mode) {
                        this.activityRerunMode[activityTitle] = null;
                    } else {
                        // 否则设置新的模式
                        this.activityRerunMode[activityTitle] = mode;
                    }
                    this.saveToLocalStorage();
                },

                // 新增：活动完成状态切换方法
                toggleActivityCompletion(activityTitle) {
                    // 如果是妄夜迷章活动，同时更新 nightMazeCompleted
                    if (activityTitle === '妄夜迷章') {
                        this.nightMazeCompleted = this.activityCompleted[activityTitle];
                    }
                    this.saveToLocalStorage();
                },

                // 新增：活动审查奖励完成状态切换方法
                toggleActivityReviewCompletion(activityTitle) {
                    this.saveToLocalStorage();
                },

                // 新增：活动角色试用奖励完成状态切换方法
                toggleActivityTrialCompletion(activityTitle) {
                    this.saveToLocalStorage();
                },

                toggleSection(section) {
                    this.sections[section] = !this.sections[section];
                    
                    // 如果展开的是包含饼状图的模块，重新绘制饼状图
                    if (section === 'pullSummary' && this.sections.pullSummary) {
                        this.$nextTick(() => {
                            this.updatePieChart();
                        });
                    }
                },
                
                adjustSkinCount(price, change) {
                    const skinKey = `skin${price}`;
                    if (this.skinReserve[skinKey] !== undefined) {
                        const newValue = this.skinReserve[skinKey] + change;
                        if (newValue >= 0) {
                            this.skinReserve[skinKey] = newValue;
                        }
                    }
                },

                validateCertificationInput() {
                    // 确保值为整数且非负数
                    if (this.trackingCertificationCount < 0) {
                        this.trackingCertificationCount = 0;
                    }
                    if (this.trackingCertificationCount !== null && this.trackingCertificationCount !== undefined) {
                        this.trackingCertificationCount = Math.floor(this.trackingCertificationCount);
                    }
                },
                
                toggleTrainingMode(mode) {
                    this.trainingModes[mode] = !this.trainingModes[mode];
                },
                
                toggleDataGap(category, type) {
                    this.dataGap[category][type] = !this.dataGap[category][type];
                },

                // 新增模块方法
                toggleMainStory(type) {
                    this.mainStory[type] = !this.mainStory[type];
                },

                // 狄斯暗影（EX）方法
                toggleDarkShadowEx(type) {
                    this.darkShadowEx[type] = !this.darkShadowEx[type];
                },

                toggleMemoryStorm(type) {
                    this.memoryStorm[type] = !this.memoryStorm[type];
                },

                togglePollutionNest(type) {
                    this.pollutionNest[type] = !this.pollutionNest[type];
                },

                toggleCleanupOperation(type) {
                    this.cleanupOperation[type] = !this.cleanupOperation[type];
                },

                togglePalmaRuins(type) {
                    this.palmaRuins[type] = !this.palmaRuins[type];
                },
                
                // 角色养成模块方法
                toggleHaylaReview() {
                    this.characterDevelopment.haylaReviewed = !this.characterDevelopment.haylaReviewed;
                },
                
                adjustCharacterDev(type, change) {
                    // 确保当前值是数字类型
                    const currentValue = Number(this.characterDevelopment[type]) || 0;
                    const newValue = currentValue + change;
                    
                    // 确保新值不小于0
                    if (newValue >= 0) {
                        this.characterDevelopment[type] = newValue;
                    }
                },

                calculateNightmareRewards() {
                    let totalCrystal = 0;
                    let totalTickets = 0;
                    
                    console.log('当前积分:', this.nightmareScore);
                    console.log('开始计算积分奖励...');
                    
                    for (const reward of this.nightmareRewards) {
                        // 只计算大于当前积分的奖励
                        if (this.nightmareScore < reward.score) {
                            console.log(`积分 ${reward.score}: +${reward.crystal}异方晶`);
                            totalCrystal += reward.crystal;
                            totalTickets += reward.tickets;
                        }
                    }
                    
                    console.log('总异方晶:', totalCrystal);
                    console.log('总搜索令:', totalTickets);
                    
                    return {
                        crystal: totalCrystal,
                        tickets: totalTickets
                    };
                },

                validateInput(type) {
                    // 确保值为整数且非负数
                    if (this.resources[type] < 0) {
                        this.resources[type] = 0;
                    }
                    if (this.resources[type] !== null && this.resources[type] !== undefined) {
                        this.resources[type] = Math.floor(this.resources[type]);
                    }
                },
                
                adjustMonthlyCard(change) {
                    const newValue = this.monthlyCardCount + change;
                    
                    // 检查是否从5增加到6
                    if (this.monthlyCardCount === 5 && change === 1) {
                        this.showAutoCloseAlert("剩余有效日期>150天时将无法继续购买月卡");
                        return;
                    }
                    
                    // 限制只能在-1到5之间（现在允许到5）
                    if (newValue >= -1 && newValue <= 5) {
                        this.monthlyCardCount = newValue;
                    }
                },

                showAutoCloseAlert(message) {
                    // 创建提示元素
                    const alertDiv = document.createElement('div');
                    alertDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        z-index: 10000;
                        font-size: 14px;
                        text-align: center;
                    `;
                    alertDiv.textContent = message;
                    
                    // 添加到页面
                    document.body.appendChild(alertDiv);
                    
                    // 3秒后自动移除
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 3000);
                },

                toggleMonthlyCard() {
                    this.monthlyCardActive = !this.monthlyCardActive;
                },

                // 高级监察密令额外购买按钮限制：
                adjustInspectionOrder(change) {
                    const newValue = this.inspectionOrderCount + change;
                    
                    // 上限为经历期数-1
                    const maxLimit = this.calculateInspectionPeriods - 1;
                    
                    // 检查是否达到上限
                    if (newValue > maxLimit) {
                        this.showAutoCloseAlert(`指定时间内仅经历${maxLimit + 1}期监察密令`);
                        return;
                    }
                    
                    // 限制在-1到maxLimit之间
                    if (newValue >= -1 && newValue <= maxLimit) {
                        this.inspectionOrderCount = newValue;
                    }
                },

                toggleInspectionOrder() {
                    this.inspectionOrderActive = !this.inspectionOrderActive;
                },

                calculateDisplayDays(timeType) {
                    const baseDays = timeType === 'nextVersion' ? this.daysToNextVersion : this.daysToNewYear;
                    return this.calculateToPoolEnd ? baseDays + (this.versionWeeks * 7) : baseDays;
                },

                // 狄斯盈满钵滑块吸附到指定挡位
                snapDisiLevel() {
                    const levels = [0, 5, 10, 15, 20, 25, 30, 35, 40, 42, 44, 46, 48, 50];
                    let closestLevel = levels[0];
                    let minDiff = Math.abs(this.disiLevel - levels[0]);
                    
                    for (let i = 1; i < levels.length; i++) {
                        const diff = Math.abs(this.disiLevel - levels[i]);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestLevel = levels[i];
                        }
                    }
                    
                    // 只有当当前值不等于最接近的挡位时才更新
                    if (this.disiLevel !== closestLevel) {
                        this.disiLevel = closestLevel;
                    }
                },

                // 切换狄斯盈满钵激活状态
                toggleDisi() {
                    this.disiActive = !this.disiActive;
                    // 如果关闭按钮，重置滑块到0级
                    if (!this.disiActive) {
                        this.disiLevel = 0;
                        this.disiPrePurchased = false;
                    }
                },

                // 切换诡珑珍宝馆激活状态
                toggleTreasure() {
                    this.treasureActive = !this.treasureActive;
                    // 如果关闭按钮，关闭预购买
                    if (!this.treasureActive) {
                        this.treasurePrePurchased = false;
                    }
                },                

            },

            // mounted生命周期应该在这里
            mounted() {
                // 初始化饼状图
                this.updatePieChart();
                
                // 监听数据变化，更新饼状图
                this.$watch(() => [
                    this.currentPulls,
                    this.dailyAccumulationCrystal,
                    this.dailyAccumulationTickets,
                    this.activityRewardsCrystal,
                    this.activityRewardsTickets,
                    this.otherSystemsCrystal,
                    this.otherSystemsTickets,
                    this.rechargeCrystal,
                    this.rechargeTickets,
                    this.previewCodeCrystal,
                    this.maintenanceCrystal,
                    this.maintenanceRepairCrystal,
                    // 添加对狄斯盈满钵的监听
                    this.disiActive,
                    this.disiPremiumCrystal,
                    this.disiLevel,
                    this.disiPrePurchased,
                    // 添加对限定券的监听
                    this.totalLimitedCouponsSummary,
                    this.selectedTime,
                    this.calculateToPoolEnd
                ], () => {
                    // 只有在饼状图模块展开时才更新图表
                    if (this.sections.pullSummary) {
                        this.updatePieChart();
                    }
                }, { deep: true });

                // 监听窗口大小变化，重新绘制饼状图
                window.addEventListener('resize', this.handleResize);
            },

            beforeUnmount() {
                // 移除窗口大小变化监听
                window.removeEventListener('resize', this.handleResize);
            },

            // 在methods中添加resize处理方法
            // 在methods对象中添加：
            handleResize() {
                // 只有在饼状图模块展开时才重新绘制
                if (this.sections.pullSummary) {
                    this.$nextTick(() => {
                        this.updatePieChart();
                    });
                }
            },
        })

        // 添加错误处理
        try {
            app.mount('#app');
        } catch (error) {
            console.error('页面加载失败:', error);
            // 显示简单错误信息
            document.getElementById('app').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h2>⚠️ 页面加载遇到问题</h2>
                    <p>请尝试：</p>
                    <button onclick="localStorage.removeItem('gachaCalculatorData'); location.reload();" 
                            style="padding: 10px; margin: 5px; background: #1890ff; color: white; border: none; border-radius: 5px;">
                        清除数据并刷新
                    </button>
                    <button onclick="location.reload()" 
                            style="padding: 10px; margin: 5px; background: #ccc; border: none; border-radius: 5px;">
                        直接刷新
                    </button>
                </div>
            `;
        }

    </script>
</body>
</html>